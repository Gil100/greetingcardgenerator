<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מחולל כרטיסי ברכה</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🎉</text></svg>">
    <script>
        // Suppress production warnings
        if (typeof process === 'undefined') {
            window.process = { env: { NODE_ENV: 'production' } };
        }
    </script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
        }
        .hebrew-text {
            direction: rtl;
            text-align: right;
        }
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .error-boundary {
            color: #dc2626;
            background-color: #fef2f2;
            border: 1px solid #fecaca;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-presets="react">
        const { useState, useEffect, useMemo, useRef } = React;

        // Simple SVG icon components to replace lucide-react
        const Heart = ({ size = 24, className = "" }) => (
            React.createElement("svg", {
                width: size,
                height: size,
                viewBox: "0 0 24 24",
                fill: "none",
                stroke: "currentColor",
                strokeWidth: "2",
                strokeLinecap: "round",
                strokeLinejoin: "round",
                className: className
            }, React.createElement("path", {
                d: "M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"
            }))
        );

        const Gift = ({ size = 24, className = "" }) => (
            React.createElement("svg", {
                width: size,
                height: size,
                viewBox: "0 0 24 24",
                fill: "none",
                stroke: "currentColor",
                strokeWidth: "2",
                strokeLinecap: "round",
                strokeLinejoin: "round",
                className: className
            }, 
            React.createElement("polyline", { points: "20,12 20,22 4,22 4,12" }),
            React.createElement("rect", { x: "2", y: "7", width: "20", height: "5" }),
            React.createElement("line", { x1: "12", y1: "22", x2: "12", y2: "7" }),
            React.createElement("path", { d: "m12,7 0,-3C12,2 10,2 10,2S8,2 8,4s2,2 2,2 2,0 2,1Z" }),
            React.createElement("path", { d: "m12,7 0,-3c0,-2 2,-2 2,-2s2,0 2,2-2,2-2,2-2,0-2,1Z" })
            )
        );

        const Sparkles = ({ size = 24, className = "" }) => (
            React.createElement("svg", {
                width: size,
                height: size,
                viewBox: "0 0 24 24",
                fill: "none",
                stroke: "currentColor",
                strokeWidth: "2",
                strokeLinecap: "round",
                strokeLinejoin: "round",
                className: className
            },
            React.createElement("path", { d: "m12,3-1.5,6L4,12l6.5,3L12,21l1.5-6L20,12l-6.5-3Z" }),
            React.createElement("path", { d: "M8,8h.01" }),
            React.createElement("path", { d: "M16,8h.01" }),
            React.createElement("path", { d: "M12,16h.01" })
            )
        );

        const Download = ({ size = 24, className = "" }) => (
            React.createElement("svg", {
                width: size,
                height: size,
                viewBox: "0 0 24 24",
                fill: "none",
                stroke: "currentColor",
                strokeWidth: "2",
                strokeLinecap: "round",
                strokeLinejoin: "round",
                className: className
            },
            React.createElement("path", { d: "M21,15v4a2,2 0,0 1,-2,2H5a2,2 0,0 1,-2,-2V15" }),
            React.createElement("polyline", { points: "7,10 12,15 17,10" }),
            React.createElement("line", { x1: "12", y1: "15", x2: "12", y2: "3" })
            )
        );

        const Share2 = ({ size = 24, className = "" }) => (
            React.createElement("svg", {
                width: size,
                height: size,
                viewBox: "0 0 24 24",
                fill: "none",
                stroke: "currentColor",
                strokeWidth: "2",
                strokeLinecap: "round",
                strokeLinejoin: "round",
                className: className
            },
            React.createElement("circle", { cx: "18", cy: "5", r: "3" }),
            React.createElement("circle", { cx: "6", cy: "12", r: "3" }),
            React.createElement("circle", { cx: "18", cy: "19", r: "3" }),
            React.createElement("line", { x1: "8.59", y1: "13.51", x2: "15.42", y2: "17.49" }),
            React.createElement("line", { x1: "15.41", y1: "6.51", x2: "8.59", y2: "10.49" })
            )
        );

        const AlertCircle = ({ size = 24, className = "" }) => (
            React.createElement("svg", {
                width: size,
                height: size,
                viewBox: "0 0 24 24",
                fill: "none",
                stroke: "currentColor",
                strokeWidth: "2",
                strokeLinecap: "round",
                strokeLinejoin: "round",
                className: className
            },
            React.createElement("circle", { cx: "12", cy: "12", r: "10" }),
            React.createElement("line", { x1: "12", y1: "8", x2: "12", y2: "12" }),
            React.createElement("line", { x1: "12", y1: "16", x2: "12.01", y2: "16" })
            )
        );

        // Add error handling for missing dependencies
        if (typeof React === 'undefined' || typeof ReactDOM === 'undefined') {
            document.getElementById('root').innerHTML = `
                <div style="padding: 20px; color: red; text-align: center; font-family: Arial;">
                    <h2>שגיאה בטעינת התלויות</h2>
                    <p>אנא רענן את הדף ונסה שוב</p>
                    <button onclick="window.location.reload()">רענן דף</button>
                </div>
            `;
            throw new Error('Missing dependencies');
        }

        // Error Boundary Component
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true, error: error };
            }

            componentDidCatch(error, errorInfo) {
                console.error('Error caught by boundary:', error, errorInfo);
                this.save_error_to_storage(error, errorInfo);
            }

            save_error_to_storage(error, errorInfo) {
                try {
                    const errorData = {
                        error: error.toString(),
                        errorInfo: errorInfo,
                        timestamp: new Date().toISOString()
                    };
                    localStorage.setItem('app_last_error', JSON.stringify(errorData));
                } catch (e) {
                    console.error('Failed to save error to storage:', e);
                }
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="error-boundary">
                            <div className="flex items-center gap-2 mb-2">
                                <AlertCircle size={20} />
                                <h2 className="text-lg font-semibold">אירעה שגיאה באפליקציה</h2>
                            </div>
                            <p className="text-sm">אנא רענן את הדף ונסה שוב.</p>
                            <button 
                                onClick={() => window.location.reload()}
                                className="mt-2 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700"
                            >
                                רענן דף
                            </button>
                        </div>
                    );
                }

                return this.props.children;
            }
        }

        // Mock Claude API for development with personalization
        const mock_claude_api = {
            complete: async (prompt) => {
                // Simulate API delay
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Extract information from prompt for personalization
                const extract_info_from_prompt = (prompt) => {
                    const name_match = prompt.match(/שם:\s*([^\n\r]+)/);
                    const age_match = prompt.match(/גיל:\s*([^\n\r]+)/);
                    const gender_match = prompt.match(/מין:\s*([^\n\r]+)/);
                    const relationship_match = prompt.match(/הקשר:\s*([^\n\r]+)/);
                    const tone_match = prompt.match(/בטון\s*([^\.\n\r]+)/);
                    const personal_match = prompt.match(/פרטים אישיים:\s*([^\n\r]+)/);
                    const notes_match = prompt.match(/הערות נוספות:\s*([^\n\r]+)/);
                    
                    return {
                        name: name_match ? name_match[1].trim() : '',
                        age: age_match ? age_match[1].trim() : '',
                        gender: gender_match ? gender_match[1].trim() : '',
                        relationship: relationship_match ? relationship_match[1].trim() : '',
                        tone: tone_match ? tone_match[1].trim() : '',
                        personalDetails: personal_match ? personal_match[1].trim() : '',
                        additionalNotes: notes_match ? notes_match[1].trim() : ''
                    };
                };

                const info = extract_info_from_prompt(prompt);
                
                // Helper function to get gender-appropriate text
                const get_gender_forms = (gender) => {
                    const is_male = gender === 'זכר';
                    return {
                        dear: is_male ? 'יקר' : 'יקרה',
                        you: is_male ? 'אתה' : 'את',
                        beautiful: is_male ? 'נהדר' : 'נהדרת',
                        skilled: is_male ? 'מוכשר' : 'מוכשרת',
                        beloved: is_male ? 'אהוב' : 'אהובה',
                        brings: is_male ? 'מביא' : 'מביאה',
                        continue: is_male ? 'תמשיך' : 'תמשיכי',
                        special: is_male ? 'המיוחד' : 'המיוחדת',
                        surrounded: is_male ? 'מוקף' : 'מוקפת',
                        getMarried: is_male ? 'תתחתן' : 'תתחתני',
                        grandpa: is_male ? 'סבא' : 'סבתא',
                        helper: is_male ? 'עוזר' : 'עוזרת',
                        receive: is_male ? 'תקבל' : 'תקבלי',
                        shaper: is_male ? 'מעצב' : 'מעצבת',
                        doer: is_male ? 'עושה' : 'עושה',
                        friend: is_male ? 'חבר' : 'חברה',
                        sibling: is_male ? 'אח' : 'אחות',
                        colleague: is_male ? 'עמית' : 'עמיתה',
                        doctor: is_male ? 'רופא' : 'רופאה',
                        teacher: is_male ? 'מורה' : 'מורה'
                    };
                };

                // Generate personalized response based on event type and extracted info
                const generate_personalized_greeting = (event_type, info) => {
                    let greeting = '';
                    const name = info.name || (info.gender === 'זכר' ? 'יקר' : 'יקרה');
                    const tone = info.tone || '';
                    const gender_forms = get_gender_forms(info.gender);
                    const is_male = info.gender === 'זכר';
                    
                    // Base greeting by event type
                    if (event_type.includes('יום הולדת')) {
                        if (tone.includes('מצחיק')) {
                            greeting = `${name} ה${gender_forms.dear}, עוד שנה עברה ו${gender_forms.you} עדיין ${gender_forms.beautiful}! מזל טוב על יום ההולדת. שהשנה הבאה תביא לך הרבה צחוק, אושר ואולי קצת פחות נרות על העוגה!`;
                        } else if (tone.includes('רשמי')) {
                            greeting = `לכבוד ${name}, בהגיע יום הולדתך הנני להביע לך את ברכותיי הכנות. שתזכה לשנים רבות ונעימות מלאות בריאות ואושר.`;
                        } else if (tone.includes('רגשי')) {
                            greeting = `${name} ה${gender_forms.beloved}, יום הולדתך הוא יום מיוחד עבור כל מי שאוהב אותך. ${gender_forms.you} ${gender_forms.brings} כל כך הרבה אור לחיים של האנשים סביבך. מזל טוב וש${gender_forms.continue} להיות הדמות ${gender_forms.special} ש${gender_forms.you}!`;
                        } else {
                            greeting = `מזל טוב ${name} על יום הולדתך! שתזכה לשנה מלאה בבריאות, אושר והצלחה. שכל חלומותיך יתגשמו וש${gender_forms.continue} לשמח את כל הסובבים אותך.`;
                        }
                    } else if (event_type.includes('חתונה')) {
                        if (tone.includes('מצחיק')) {
                            greeting = `${name}, הגיע הזמן! אחרי כל השנים של "מתי ${gender_forms.getMarried}?" סוף סוף! מזל טוב על החתונה. שתמיד תזכרו שהמילים הכי חשובות בנישואין הן "${gender_forms.you} ${is_male ? 'צודק' : 'צודקת'} יקירי!"`;
                        } else if (tone.includes('רשמי')) {
                            greeting = `לכבוד ${name}, בהזדמנות נישואיכם הבאתי להביע את ברכותיי הכנות. שתזכו לחיים משותפים מלאי אהבה, הבנה ואושר.`;
                        } else {
                            greeting = `מזל טוב ${name} על נישואיך! שתזכו לבית נאמן בישראל, מלא באהבה, כבוד הדדי ואושר אמיתי. שתבנו יחד עתיד מזהיר ומלא ברכה.`;
                        }
                    } else if (event_type.includes('נכד חדש') || event_type.includes('נכדה חדשה')) {
                        if (tone.includes('מצחיק')) {
                            greeting = `${name}, מזל טוב על הנכד החדש! עכשיו ${gender_forms.you} רשמית ${gender_forms.grandpa} - זה אומר שאפשר לפנק בלי מוסר ולהחזיר הביתה! איזה כיף גדול מחכה לך.`;
                        } else if (tone.includes('רגשי')) {
                            greeting = `${name} ה${gender_forms.dear}, איזה רגש מתוק ומיוחד! נכד חדש זה לא רק תינוק, זה המשך הדרך, חוליה נוספת בשרשרת האהבה שלכם. שתזכו להיות ${gender_forms.grandpa} ${is_male ? 'גאה' : 'גאה'} ולראות אותו גדל ופורח.`;
                        } else {
                            greeting = `מזל טוב ${name} על הנכד החדש! איזה שמחה גדולה ומיוחדת. שתזכו לראות אותו גדל ומתפתח, ושתהיו ${gender_forms.grandpa} ${is_male ? 'גאה' : 'גאה'} ואוהבים. ברכות לכל המשפחה!`;
                        }
                    } else if (event_type.includes('עליה לארץ')) {
                        greeting = `${name}, ברוכים הבאים הביתה! עליה לארץ היא התגשמות חלום. שתקלטו בקלות, תמצאו את מקומכם ותהנו מכל הטוב שיש לארץ להציע. בהצלחה במסע החדש!`;
                    } else {
                        greeting = `מזל טוב ${name}! שתמיד תהיה ${gender_forms.surrounded} באהבה ובשמחה. שכל הטוב בעולם יגיע אליך ותמיד תמצא סיבות לחייך.`;
                    }
                    
                    // Add personal details if provided
                    if (info.personalDetails) {
                        if (info.personalDetails.includes('רופא') || info.personalDetails.includes('רופאה')) {
                            greeting += ` כ${gender_forms.doctor} ${gender_forms.skilled}, ${gender_forms.you} ${gender_forms.helper} לכל כך הרבה אנשים - הגיע הזמן שגם ${gender_forms.you} ${gender_forms.receive} חזרה את כל הטוב הזה.`;
                        } else if (info.personalDetails.includes('מורה')) {
                            greeting += ` המקצוע שלך כ${gender_forms.teacher} הוא מקצוע קדוש - ${gender_forms.you} ${gender_forms.shaper} את העתיד. תודה על כל מה ש${gender_forms.you} ${gender_forms.doer}.`;
                        } else if (info.personalDetails.includes('מוסיקה') || info.personalDetails.includes('נגינה')) {
                            greeting += ` כמו ש${gender_forms.you} ${gender_forms.brings} מוסיקה יפה לעולם, ככה החיים שלך מלאים במלודיות מתוקות.`;
                        }
                    }
                    
                    // Add relationship context
                    if (info.relationship) {
                        if (info.relationship.includes('אח') || info.relationship.includes('אחות')) {
                            greeting += ` כל הכבוד שיש לי ${gender_forms.sibling} כמוך!`;
                        } else if (info.relationship.includes('חבר')) {
                            greeting += ` איזה מזל שיש לי ${gender_forms.friend} כמוך בחיים!`;
                        } else if (info.relationship.includes('עמית')) {
                            greeting += ` העבודה איתך היא תמיד הנאה!`;
                        }
                    }
                    
                    return greeting;
                };
                
                // Determine event type from prompt
                let event_type = '';
                if (prompt.includes('יום הולדת')) event_type = 'יום הולדת';
                else if (prompt.includes('חתונה')) event_type = 'חתונה';
                else if (prompt.includes('נכד חדש') || prompt.includes('נכדה חדשה')) event_type = 'נכד חדש';
                else if (prompt.includes('עליה לארץ')) event_type = 'עליה לארץ';
                else if (prompt.includes('בר מצווה') || prompt.includes('בת מצווה')) event_type = 'בר מצווה';
                else event_type = 'כללי';
                
                return generate_personalized_greeting(event_type, info);
            }
        };

        // Initialize Claude API
        if (typeof window.claude === 'undefined') {
            window.claude = mock_claude_api;
        }

        const GreetingCardGenerator = () => {
            const [form_data, set_form_data] = useState({
                eventType: '',
                customEventType: '',
                recipientName: '',
                recipientAge: '',
                recipientGender: '',
                relationship: '',
                personalDetails: '',
                tone: [],
                additionalNotes: ''
            });
            
            const [generated_card, set_generated_card] = useState(null);
            const [is_generating, set_is_generating] = useState(false);
            const [error_message, set_error_message] = useState('');

            const event_types = [
                { value: 'birthday', label: 'יום הולדת', icon: '🎂' },
                { value: 'wedding', label: 'חתונה', icon: '💒' },
                { value: 'barmitzvah', label: 'בר/בת מצווה', icon: '📜' },
                { value: 'engagement', label: 'אירוסין', icon: '💍' },
                { value: 'graduation', label: 'סיום לימודים', icon: '🎓' },
                { value: 'newjob', label: 'עבודה חדשה', icon: '💼' },
                { value: 'holiday', label: 'חג', icon: '✨' },
                { value: 'anniversary', label: 'יום נישואין', icon: '❤️' },
                { value: 'custom', label: 'אירוע אחר', icon: '🎉' }
            ];

            const tones = [
                { value: 'warm', label: 'חם ואישי' },
                { value: 'funny', label: 'מצחיק' },
                { value: 'formal', label: 'רשמי' },
                { value: 'emotional', label: 'רגשי' },
                { value: 'casual', label: 'קליל' }
            ];

            const genders = [
                { value: 'male', label: 'זכר' },
                { value: 'female', label: 'נקבה' }
            ];

            // Load data from localStorage on component mount
            useEffect(() => {
                try {
                    const saved_data = localStorage.getItem('greeting_card_form_data');
                    if (saved_data) {
                        set_form_data(JSON.parse(saved_data));
                    }
                } catch (error) {
                    console.error('Failed to load saved data:', error);
                }
            }, []);

            // Save data to localStorage whenever form_data changes
            useEffect(() => {
                try {
                    localStorage.setItem('greeting_card_form_data', JSON.stringify(form_data));
                } catch (error) {
                    console.error('Failed to save data:', error);
                }
            }, [form_data]);

            const handle_input_change = (field, value) => {
                set_form_data(prev => ({
                    ...prev,
                    [field]: value
                }));
                set_error_message(''); // Clear error when user starts typing
            };

            const validate_form = () => {
                if (!form_data.eventType) {
                    set_error_message('אנא בחר סוג אירוע');
                    return false;
                }
                if (form_data.eventType === 'custom' && !form_data.customEventType.trim()) {
                    set_error_message('אנא פרט את סוג האירוע');
                    return false;
                }
                if (!form_data.recipientName.trim()) {
                    set_error_message('אנא הכנס שם מקבל הברכה');
                    return false;
                }
                if (!form_data.tone.length) {
                    set_error_message('אנא בחר לפחות טון אחד לברכה');
                    return false;
                }
                if (!form_data.recipientGender) {
                    set_error_message('אנא בחר מין מקבל הברכה');
                    return false;
                }
                return true;
            };

            const generate_greeting = async () => {
                if (!validate_form()) {
                    return;
                }

                set_is_generating(true);
                set_error_message('');
                
                try {
                    const selected_event = event_types.find(e => e.value === form_data.eventType);
                    const selected_tones = form_data.tone.map(t => tones.find(tone => tone.value === t).label);
                    const selected_gender = genders.find(g => g.value === form_data.recipientGender);
                    
                    // Determine event name for prompt
                    const event_name = form_data.eventType === 'custom' 
                        ? form_data.customEventType 
                        : selected_event.label;
                    
                    const prompt = `
                    צור ברכה מותאמת אישית עבור ${event_name} בטון ${selected_tones.join(' ו')}.
                    
                    פרטי מקבל הברכה:
                    - שם: ${form_data.recipientName}
                    - מין: ${selected_gender.label}
                    ${form_data.recipientAge ? `- גיל: ${form_data.recipientAge}` : ''}
                    ${form_data.relationship ? `- הקשר: ${form_data.relationship}` : ''}
                    
                    ${form_data.personalDetails ? `פרטים אישיים: ${form_data.personalDetails}` : ''}
                    
                    ${form_data.additionalNotes ? `הערות נוספות: ${form_data.additionalNotes}` : ''}
                    
                    הנחיות חשובות:
                    - כתוב בעברית בלבד
                    - צור ברכה אנושית וטבעיה שלא נשמעת מלאכותית
                    - השתמש בביטויים ישראליים טבעיים
                    - הימנע מביטויים קלישאתיים או גנריים
                    - התאם את האורך לסוג האירוע (2-4 משפטים)
                    - הקפד על טון ${selected_tones.join(' ו')}
                    - שלב את הפרטים האישיים בצורה חלקה
                    - השתמש בצורת הפנייה המתאימה למין המקבל (זכר/נקבה) - לדוגמה: "אתה/את", "יקר/יקרה", "מוכשר/מוכשרת"
                    ${form_data.eventType === 'custom' ? `- התאם את הברכה ספציפית לאירוע "${form_data.customEventType}"` : ''}
                    
                    החזר רק את טקסט הברכה, ללא הסברים או הערות נוספות.
                    `;

                    const response = await window.claude.complete(prompt);
                    
                    const card_data = {
                        text: response,
                        eventType: form_data.eventType,
                        customEventType: form_data.customEventType,
                        recipientName: form_data.recipientName,
                        eventIcon: selected_event.icon,
                        eventName: event_name,
                        createdAt: new Date().toISOString()
                    };

                    set_generated_card(card_data);
                    
                    // Save generated card to localStorage
                    try {
                        const saved_cards = JSON.parse(localStorage.getItem('generated_cards') || '[]');
                        saved_cards.push(card_data);
                        // Keep only last 10 cards
                        if (saved_cards.length > 10) {
                            saved_cards.splice(0, saved_cards.length - 10);
                        }
                        localStorage.setItem('generated_cards', JSON.stringify(saved_cards));
                    } catch (error) {
                        console.error('Failed to save generated card:', error);
                    }
                    
                } catch (error) {
                    console.error('שגיאה ביצירת הברכה:', error);
                    set_error_message('אירעה שגיאה ביצירת הברכה. אנא נסה שוב.');
                } finally {
                    set_is_generating(false);
                }
            };

            const get_card_background = useMemo(() => {
                const backgrounds = {
                    birthday: 'bg-gradient-to-br from-pink-400 via-purple-400 to-indigo-400',
                    wedding: 'bg-gradient-to-br from-rose-300 via-pink-300 to-red-300',
                    barmitzvah: 'bg-gradient-to-br from-blue-400 via-indigo-400 to-purple-400',
                    engagement: 'bg-gradient-to-br from-yellow-300 via-orange-300 to-red-300',
                    graduation: 'bg-gradient-to-br from-green-400 via-teal-400 to-blue-400',
                    newjob: 'bg-gradient-to-br from-gray-400 via-slate-400 to-zinc-400',
                    holiday: 'bg-gradient-to-br from-amber-400 via-yellow-400 to-orange-400',
                    anniversary: 'bg-gradient-to-br from-red-400 via-rose-400 to-pink-400'
                };
                return (eventType) => backgrounds[eventType] || 'bg-gradient-to-br from-blue-400 to-purple-400';
            }, []);

            const reset_form = () => {
                set_form_data({
                    eventType: '',
                    customEventType: '',
                    recipientName: '',
                    recipientAge: '',
                    recipientGender: '',
                    relationship: '',
                    personalDetails: '',
                    tone: [],
                    additionalNotes: ''
                });
                set_generated_card(null);
                set_error_message('');
            };

            const handle_share = async () => {
                try {
                    if (navigator.share) {
                        await navigator.share({
                            title: 'כרטיס ברכה',
                            text: generated_card.text
                        });
                    } else {
                        await navigator.clipboard.writeText(generated_card.text);
                        alert('הברכה הועתקה ללוח');
                    }
                } catch (error) {
                    console.error('Share failed:', error);
                    // Fallback to manual copy
                    try {
                        await navigator.clipboard.writeText(generated_card.text);
                        alert('הברכה הועתקה ללוח');
                    } catch (clipboardError) {
                        console.error('Clipboard failed:', clipboardError);
                        alert('לא ניתן לשתף או להעתיק את הברכה');
                    }
                }
            };

            const download_card_as_image = async () => {
                try {
                    // Create a canvas
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Set canvas size (card proportions)
                    canvas.width = 800;
                    canvas.height = 600;
                    
                    // Get the card's background gradient
                    const gradient_backgrounds = {
                        birthday: ['#f472b6', '#a855f7', '#6366f1'],
                        wedding: ['#fb7185', '#f9a8d4', '#ef4444'],
                        barmitzvah: ['#60a5fa', '#8b5cf6', '#a855f7'],
                        engagement: ['#fde047', '#fb923c', '#ef4444'],
                        graduation: ['#4ade80', '#14b8a6', '#3b82f6'],
                        newjob: ['#9ca3af', '#64748b', '#52525b'],
                        holiday: ['#f59e0b', '#eab308', '#f97316'],
                        anniversary: ['#ef4444', '#f43f5e', '#ec4899']
                    };
                    
                    const event_colors = gradient_backgrounds[generated_card.eventType] || ['#3b82f6', '#8b5cf6'];
                    
                    // Create gradient background
                    const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
                    gradient.addColorStop(0, event_colors[0]);
                    gradient.addColorStop(0.5, event_colors[1]);
                    gradient.addColorStop(1, event_colors[2] || event_colors[1]);
                    
                    // Fill background with gradient
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // Draw white rounded rectangle for card content
                    const card_padding = 60;
                    const card_x = card_padding;
                    const card_y = card_padding;
                    const card_width = canvas.width - (card_padding * 2);
                    const card_height = canvas.height - (card_padding * 2);
                    const border_radius = 20;
                    
                    // Draw rounded rectangle background
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
                    ctx.beginPath();
                    
                    // Manual rounded rectangle implementation for better browser support
                    ctx.moveTo(card_x + border_radius, card_y);
                    ctx.lineTo(card_x + card_width - border_radius, card_y);
                    ctx.quadraticCurveTo(card_x + card_width, card_y, card_x + card_width, card_y + border_radius);
                    ctx.lineTo(card_x + card_width, card_y + card_height - border_radius);
                    ctx.quadraticCurveTo(card_x + card_width, card_y + card_height, card_x + card_width - border_radius, card_y + card_height);
                    ctx.lineTo(card_x + border_radius, card_y + card_height);
                    ctx.quadraticCurveTo(card_x, card_y + card_height, card_x, card_y + card_height - border_radius);
                    ctx.lineTo(card_x, card_y + border_radius);
                    ctx.quadraticCurveTo(card_x, card_y, card_x + border_radius, card_y);
                    ctx.closePath();
                    ctx.fill();
                    
                    // Set text properties for RTL Hebrew
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.direction = 'rtl';
                    
                    // Draw event icon (emoji)
                    ctx.font = '80px Arial';
                    ctx.fillStyle = '#333';
                    ctx.fillText(generated_card.eventIcon, canvas.width / 2, card_y + 120);
                    
                    // Draw event title
                    ctx.font = 'bold 36px Arial';
                    ctx.fillStyle = '#1f2937';
                    const event_title = generated_card.eventType === 'custom' 
                        ? generated_card.customEventType 
                        : event_types.find(e => e.value === generated_card.eventType)?.label;
                    ctx.fillText(event_title, canvas.width / 2, card_y + 200);
                    
                    // Draw greeting text (multi-line)
                    ctx.font = '24px Arial';
                    ctx.fillStyle = '#374151';
                    
                    // Split text into lines that fit the card width
                    const max_line_width = card_width - 80;
                    const lines = wrap_text(ctx, generated_card.text, max_line_width);
                    
                    // Draw each line
                    const line_height = 40;
                    const start_y = card_y + 280;
                    
                    lines.forEach((line, index) => {
                        ctx.fillText(line, canvas.width / 2, start_y + (index * line_height));
                    });
                    
                    // Convert canvas to blob and download
                    canvas.toBlob((blob) => {
                        const url = URL.createObjectURL(blob);
                        const download_link = document.createElement('a');
                        download_link.href = url;
                        download_link.download = `כרטיס-ברכה-${generated_card.recipientName}-${new Date().toLocaleDateString('he-IL')}.png`;
                        document.body.appendChild(download_link);
                        download_link.click();
                        document.body.removeChild(download_link);
                        URL.revokeObjectURL(url);
                    }, 'image/png');
                    
                } catch (error) {
                    console.error('Download failed:', error);
                    alert('אירעה שגיאה בהורדת הכרטיס. אנא נסה שוב.');
                }
            };
            
            // Helper function to wrap text
            const wrap_text = (ctx, text, max_width) => {
                const words = text.split(' ');
                const lines = [];
                let current_line = '';
                
                for (let i = 0; i < words.length; i++) {
                    const word = words[i];
                    const test_line = current_line + word + ' ';
                    const test_width = ctx.measureText(test_line).width;
                    
                    if (test_width > max_width && current_line !== '') {
                        lines.push(current_line.trim());
                        current_line = word + ' ';
                    } else {
                        current_line = test_line;
                    }
                }
                
                if (current_line.trim() !== '') {
                    lines.push(current_line.trim());
                }
                
                return lines;
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 hebrew-text">
                    <div className="max-w-4xl mx-auto">
                        <div className="text-center mb-8">
                            <div className="inline-flex items-center gap-2 mb-4">
                                <Sparkles className="text-purple-600" size={32} />
                                <h1 className="text-4xl font-bold text-gray-800">מחולל כרטיסי ברכה</h1>
                                <Sparkles className="text-purple-600" size={32} />
                            </div>
                            <p className="text-gray-600 text-lg">צור כרטיסי ברכה מותאמים אישית לכל אירוע</p>
                        </div>

                        {error_message && (
                            <div className="error-boundary mb-6">
                                <div className="flex items-center gap-2">
                                    <AlertCircle size={20} />
                                    <span>{error_message}</span>
                                </div>
                            </div>
                        )}

                        {!generated_card ? (
                            <div className="bg-white rounded-2xl shadow-xl p-8">
                                <div className="grid md:grid-cols-2 gap-6">
                                    {/* עמודה ראשונה */}
                                    <div className="space-y-6">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                סוג האירוע *
                                            </label>
                                            <div className="grid grid-cols-2 gap-2">
                                                {event_types.map(event => (
                                                    <button
                                                        key={event.value}
                                                        onClick={() => {
                                                            handle_input_change('eventType', event.value);
                                                            if (event.value !== 'custom') {
                                                                handle_input_change('customEventType', '');
                                                            }
                                                        }}
                                                        className={`p-3 rounded-lg border-2 transition-all flex items-center gap-2 text-sm ${
                                                            form_data.eventType === event.value
                                                                ? 'border-purple-500 bg-purple-50 text-purple-700'
                                                                : 'border-gray-200 hover:border-purple-300'
                                                        }`}
                                                    >
                                                        <span>{event.icon}</span>
                                                        <span>{event.label}</span>
                                                    </button>
                                                ))}
                                            </div>
                                            
                                            {form_data.eventType === 'custom' && (
                                                <div className="mt-4">
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                                        פרט את סוג האירוע *
                                                    </label>
                                                    <input
                                                        type="text"
                                                        value={form_data.customEventType}
                                                        onChange={(e) => handle_input_change('customEventType', e.target.value)}
                                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                                        placeholder="לדוגמא: נכד חדש, עליה לארץ, יום הולדת 50..."
                                                    />
                                                </div>
                                            )}
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                שם מקבל הברכה *
                                            </label>
                                            <input
                                                type="text"
                                                value={form_data.recipientName}
                                                onChange={(e) => handle_input_change('recipientName', e.target.value)}
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                                placeholder="הכנס שם..."
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                גיל (אופציונלי)
                                            </label>
                                            <input
                                                type="text"
                                                value={form_data.recipientAge}
                                                onChange={(e) => handle_input_change('recipientAge', e.target.value)}
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                                placeholder="לדוגמא: 25, 30..."
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                הקשר אליך (אופציונלי)
                                            </label>
                                            <input
                                                type="text"
                                                value={form_data.relationship}
                                                onChange={(e) => handle_input_change('relationship', e.target.value)}
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                                placeholder="לדוגמא: חבר, אח, עמית לעבודה..."
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                מין מקבל הברכה *
                                            </label>
                                            <div className="grid grid-cols-2 gap-2">
                                                {genders.map(gender => (
                                                    <button
                                                        key={gender.value}
                                                        onClick={() => handle_input_change('recipientGender', gender.value)}
                                                        className={`p-3 rounded-lg border-2 transition-all ${
                                                            form_data.recipientGender === gender.value
                                                                ? 'border-purple-500 bg-purple-50 text-purple-700'
                                                                : 'border-gray-200 hover:border-purple-300'
                                                        }`}
                                                    >
                                                        {gender.label}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    </div>

                                    {/* עמודה שנייה */}
                                    <div className="space-y-6">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                טון הברכה * (ניתן לבחור יותר מאחד)
                                            </label>
                                            <div className="space-y-2">
                                                {tones.map(tone => (
                                                    <button
                                                        key={tone.value}
                                                        onClick={() => {
                                                            const current_tones = form_data.tone;
                                                            const is_selected = current_tones.includes(tone.value);
                                                            if (is_selected) {
                                                                handle_input_change('tone', current_tones.filter(t => t !== tone.value));
                                                            } else {
                                                                handle_input_change('tone', [...current_tones, tone.value]);
                                                            }
                                                        }}
                                                        className={`w-full p-3 rounded-lg border-2 transition-all text-right ${
                                                            form_data.tone.includes(tone.value)
                                                                ? 'border-purple-500 bg-purple-50 text-purple-700'
                                                                : 'border-gray-200 hover:border-purple-300'
                                                        }`}
                                                    >
                                                        {tone.label}
                                                    </button>
                                                ))}
                                            </div>
                                            {form_data.tone.length > 0 && (
                                                <div className="mt-2 text-sm text-gray-600">
                                                    נבחרו: {form_data.tone.map(t => tones.find(tone => tone.value === t)?.label).join(', ')}
                                                </div>
                                            )}
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                פרטים אישיים (אופציונלי)
                                            </label>
                                            <textarea
                                                value={form_data.personalDetails}
                                                onChange={(e) => handle_input_change('personalDetails', e.target.value)}
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent h-24 resize-none"
                                                placeholder="תחביבים, מקצוע, זיכרונות משותפים..."
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                הערות נוספות (אופציונלי)
                                            </label>
                                            <textarea
                                                value={form_data.additionalNotes}
                                                onChange={(e) => handle_input_change('additionalNotes', e.target.value)}
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent h-20 resize-none"
                                                placeholder="לדוגמא: הקפד על ברכה אנושית, השתמש בביטויים ישראליים..."
                                            />
                                        </div>
                                    </div>
                                </div>

                                <div className="mt-8 text-center">
                                    <button
                                        onClick={generate_greeting}
                                        disabled={is_generating}
                                        className="bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-8 py-4 rounded-xl font-semibold text-lg shadow-lg hover:shadow-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 mx-auto"
                                    >
                                        {is_generating ? (
                                            <>
                                                <div className="loading-spinner rounded-full h-5 w-5 border-b-2 border-white"></div>
                                                יוצר ברכה...
                                            </>
                                        ) : (
                                            <>
                                                <Gift size={20} />
                                                צור כרטיס ברכה
                                            </>
                                        )}
                                    </button>
                                </div>
                            </div>
                        ) : (
                            <div className="space-y-6">
                                {/* כרטיס הברכה */}
                                <div className={`${get_card_background(generated_card.eventType)} p-8 rounded-2xl shadow-2xl`}>
                                    <div className="bg-white/90 backdrop-blur-sm p-8 rounded-xl text-center">
                                        <div className="text-6xl mb-4">{generated_card.eventIcon}</div>
                                        <h2 className="text-2xl font-bold text-gray-800 mb-6">
                                            {generated_card.eventType === 'custom' 
                                                ? generated_card.customEventType 
                                                : event_types.find(e => e.value === generated_card.eventType)?.label}
                                        </h2>
                                        <div className="text-lg leading-relaxed text-gray-700 whitespace-pre-wrap font-medium hebrew-text">
                                            {generated_card.text}
                                        </div>
                                    </div>
                                </div>

                                {/* כפתורי פעולה */}
                                <div className="flex justify-center gap-4 flex-wrap">
                                    <button
                                        onClick={download_card_as_image}
                                        className="bg-green-600 text-white px-6 py-3 rounded-lg font-semibold flex items-center gap-2 hover:bg-green-700 transition-colors"
                                    >
                                        <Download size={20} />
                                        הורד כרטיס
                                    </button>
                                    
                                    <button
                                        onClick={handle_share}
                                        className="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold flex items-center gap-2 hover:bg-blue-700 transition-colors"
                                    >
                                        <Share2 size={20} />
                                        שתף
                                    </button>
                                    
                                    <button
                                        onClick={reset_form}
                                        className="bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-700 transition-colors"
                                    >
                                        צור ברכה חדשה
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const App = () => {
            return (
                <ErrorBoundary>
                    <GreetingCardGenerator />
                </ErrorBoundary>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>