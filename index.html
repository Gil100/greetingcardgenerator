<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××—×•×œ×œ ×›×¨×˜×™×¡×™ ×‘×¨×›×”</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // API Configuration - embedded for production
        window.API_CONFIG = {
            GEMINI_API_KEY: 'process.env.GOOGLE_API_KEY',
            API_ENDPOINT: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent',
            DAILY_LIMIT: 1500,
            RATE_LIMIT_WINDOW: 24 * 60 * 60 * 1000,
            GENERATION_CONFIG: {
                temperature: 0.7,
                topK: 40,
                topP: 0.95,
                maxOutputTokens: 1024,
            }
        };
    </script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='https://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ‰</text></svg>">
    <script>
        // Suppress production warnings
        if (typeof process === 'undefined') {
            window.process = { env: { NODE_ENV: 'production' } };
        }
    </script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
        }
        .hebrew-text {
            direction: rtl;
            text-align: right;
        }
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .error-boundary {
            color: #dc2626;
            background-color: #fef2f2;
            border: 1px solid #fecaca;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }
    </style>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://unpkg.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://unpkg.com https://cdn.jsdelivr.net; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https:;">
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-presets="react">
        const { useState, useEffect, useMemo, useCallback, useRef } = React;

        // Constants
        const CONSTANTS = {
            CANVAS: {
                WIDTH: 800,
                HEIGHT: 600,
                PADDING: 60,
                BORDER_RADIUS: 20,
                LINE_HEIGHT: 40
            },
            FONTS: {
                ICON: '80px Arial',
                TITLE: 'bold 36px Arial',
                TEXT: '24px Arial'
            },
            COLORS: {
                CARD_BG: 'rgba(255, 255, 255, 0.95)',
                TEXT_PRIMARY: '#1f2937',
                TEXT_SECONDARY: '#374151'
            }
        };

        // Simple SVG icon components to replace lucide-react
        const Heart = ({ size = 24, className = "" }) => (
            React.createElement("svg", {
                width: size,
                height: size,
                viewBox: "0 0 24 24",
                fill: "none",
                stroke: "currentColor",
                strokeWidth: "2",
                strokeLinecap: "round",
                strokeLinejoin: "round",
                className: className
            }, React.createElement("path", {
                d: "M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"
            }))
        );

        const Gift = ({ size = 24, className = "" }) => (
            React.createElement("svg", {
                width: size,
                height: size,
                viewBox: "0 0 24 24",
                fill: "none",
                stroke: "currentColor",
                strokeWidth: "2",
                strokeLinecap: "round",
                strokeLinejoin: "round",
                className: className
            }, 
            React.createElement("polyline", { points: "20,12 20,22 4,22 4,12" }),
            React.createElement("rect", { x: "2", y: "7", width: "20", height: "5" }),
            React.createElement("line", { x1: "12", y1: "22", x2: "12", y2: "7" }),
            React.createElement("path", { d: "m12,7 0,-3C12,2 10,2 10,2S8,2 8,4s2,2 2,2 2,0 2,1Z" }),
            React.createElement("path", { d: "m12,7 0,-3c0,-2 2,-2 2,-2s2,0 2,2-2,2-2,2-2,0-2,1Z" })
            )
        );

        const Sparkles = ({ size = 24, className = "" }) => (
            React.createElement("svg", {
                width: size,
                height: size,
                viewBox: "0 0 24 24",
                fill: "none",
                stroke: "currentColor",
                strokeWidth: "2",
                strokeLinecap: "round",
                strokeLinejoin: "round",
                className: className
            },
            React.createElement("path", { d: "m12,3-1.5,6L4,12l6.5,3L12,21l1.5-6L20,12l-6.5-3Z" }),
            React.createElement("path", { d: "M8,8h.01" }),
            React.createElement("path", { d: "M16,8h.01" }),
            React.createElement("path", { d: "M12,16h.01" })
            )
        );

        const Download = ({ size = 24, className = "" }) => (
            React.createElement("svg", {
                width: size,
                height: size,
                viewBox: "0 0 24 24",
                fill: "none",
                stroke: "currentColor",
                strokeWidth: "2",
                strokeLinecap: "round",
                strokeLinejoin: "round",
                className: className
            },
            React.createElement("path", { d: "M21,15v4a2,2 0,0 1,-2,2H5a2,2 0,0 1,-2,-2V15" }),
            React.createElement("polyline", { points: "7,10 12,15 17,10" }),
            React.createElement("line", { x1: "12", y1: "15", x2: "12", y2: "3" })
            )
        );

        const Share2 = ({ size = 24, className = "" }) => (
            React.createElement("svg", {
                width: size,
                height: size,
                viewBox: "0 0 24 24",
                fill: "none",
                stroke: "currentColor",
                strokeWidth: "2",
                strokeLinecap: "round",
                strokeLinejoin: "round",
                className: className
            },
            React.createElement("circle", { cx: "18", cy: "5", r: "3" }),
            React.createElement("circle", { cx: "6", cy: "12", r: "3" }),
            React.createElement("circle", { cx: "18", cy: "19", r: "3" }),
            React.createElement("line", { x1: "8.59", y1: "13.51", x2: "15.42", y2: "17.49" }),
            React.createElement("line", { x1: "15.41", y1: "6.51", x2: "8.59", y2: "10.49" })
            )
        );

        const AlertCircle = ({ size = 24, className = "" }) => (
            React.createElement("svg", {
                width: size,
                height: size,
                viewBox: "0 0 24 24",
                fill: "none",
                stroke: "currentColor",
                strokeWidth: "2",
                strokeLinecap: "round",
                strokeLinejoin: "round",
                className: className
            },
            React.createElement("circle", { cx: "12", cy: "12", r: "10" }),
            React.createElement("line", { x1: "12", y1: "8", x2: "12", y2: "12" }),
            React.createElement("line", { x1: "12", y1: "16", x2: "12.01", y2: "16" })
            )
        );


        // Add error handling for missing dependencies
        if (typeof React === 'undefined' || typeof ReactDOM === 'undefined') {
            document.getElementById('root').innerHTML = `
                <div style="padding: 20px; color: red; text-align: center; font-family: Arial;">
                    <h2>×©×’×™××” ×‘×˜×¢×™× ×ª ×”×ª×œ×•×™×•×ª</h2>
                    <p>×× × ×¨×¢× ×Ÿ ××ª ×”×“×£ ×•× ×¡×” ×©×•×‘</p>
                    <button onclick="window.location.reload()">×¨×¢× ×Ÿ ×“×£</button>
                </div>
            `;
            throw new Error('Missing dependencies');
        }

        // Error Boundary Component
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true, error: error };
            }

            componentDidCatch(error, errorInfo) {
                console.error('Error caught by boundary:', error, errorInfo);
                this.save_error_to_storage(error, errorInfo);
            }

            save_error_to_storage(error, errorInfo) {
                try {
                    const errorData = {
                        error: error.toString(),
                        errorInfo: errorInfo,
                        timestamp: new Date().toISOString()
                    };
                    localStorage.setItem('app_last_error', JSON.stringify(errorData));
                } catch (e) {
                    console.error('Failed to save error to storage:', e);
                }
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="error-boundary">
                            <div className="flex items-center gap-2 mb-2">
                                <AlertCircle size={20} />
                                <h2 className="text-lg font-semibold">××™×¨×¢×” ×©×’×™××” ×‘××¤×œ×™×§×¦×™×”</h2>
                            </div>
                            <p className="text-sm">×× × ×¨×¢× ×Ÿ ××ª ×”×“×£ ×•× ×¡×” ×©×•×‘.</p>
                            <button 
                                onClick={() => window.location.reload()}
                                className="mt-2 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700"
                            >
                                ×¨×¢× ×Ÿ ×“×£
                            </button>
                        </div>
                    );
                }

                return this.props.children;
            }
        }

        // Rate limiting utility
        const rate_limiter = {
            get_usage_data: () => {
                const data = localStorage.getItem('api_usage_data');
                if (!data) return { count: 0, resetTime: Date.now() + (24 * 60 * 60 * 1000) };
                return JSON.parse(data);
            },
            
            save_usage_data: (data) => {
                localStorage.setItem('api_usage_data', JSON.stringify(data));
            },
            
            can_make_request: () => {
                const usage = rate_limiter.get_usage_data();
                const now = Date.now();
                
                // Reset counter if 24 hours have passed
                if (now >= usage.resetTime) {
                    const new_usage = { count: 0, resetTime: now + (24 * 60 * 60 * 1000) };
                    rate_limiter.save_usage_data(new_usage);
                    return { allowed: true, remaining: 1500 };
                }
                
                const daily_limit = window.API_CONFIG?.DAILY_LIMIT || 1500;
                const remaining = daily_limit - usage.count;
                
                return { 
                    allowed: usage.count < daily_limit, 
                    remaining: remaining,
                    resetTime: usage.resetTime 
                };
            },
            
            increment_usage: () => {
                const usage = rate_limiter.get_usage_data();
                usage.count += 1;
                rate_limiter.save_usage_data(usage);
            }
        };

        // Google Gemini API integration with rate limiting
        const gemini_api = {
            complete: async (prompt) => {
                // Check rate limits first
                const limit_check = rate_limiter.can_make_request();
                if (!limit_check.allowed) {
                    const reset_time = new Date(limit_check.resetTime).toLocaleString('he-IL');
                    throw new Error(`×—×¨×’×ª ××”××›×¡×” ×”×™×•××™×ª ×©×œ 1500 ×‘×§×©×•×ª. ×”××›×¡×” ×ª×ª×—×“×© ×‘: ${reset_time}`);
                }
                
                // Get API key from configuration
                const api_key = window.API_CONFIG && window.API_CONFIG.GEMINI_API_KEY !== 'YOUR_GEMINI_API_KEY_HERE' 
                                ? window.API_CONFIG.GEMINI_API_KEY : null;
                
                if (!api_key) {
                    throw new Error('××¤×ª×— API ×œ× ××•×’×“×¨. ×× × ×¤× ×” ×œ××¤×ª×— ×”××¤×œ×™×§×¦×™×”.');
                }
                
                try {
                    // Get API configuration
                    const config = window.API_CONFIG || {};
                    const api_endpoint = config.API_ENDPOINT || 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent';
                    const generation_config = config.GENERATION_CONFIG || {
                        temperature: 0.7,
                        topK: 40,
                        topP: 0.95,
                        maxOutputTokens: 1024,
                    };
                    
                    // Make API call to Google Gemini
                    const response = await fetch(`${api_endpoint}?key=${api_key}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: prompt
                                }]
                            }],
                            generationConfig: generation_config
                        })
                    });
                    
                    if (!response.ok) {
                        if (response.status === 401) {
                            // Invalid API key
                            throw new Error('××¤×ª×— API ×œ× ×ª×§×™×Ÿ. ×× × ×¤× ×” ×œ××¤×ª×— ×”××¤×œ×™×§×¦×™×”.');
                        } else if (response.status === 429) {
                            // Rate limit exceeded on server side
                            throw new Error('×”×©×¨×ª ××“×•×•×— ×¢×œ ×—×¨×™×’×” ××”××›×¡×”. × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.');
                        } else {
                            throw new Error(`×©×’×™××” ×‘×§×¨×™××” ×œ×©×™×¨×•×ª: ${response.status}`);
                        }
                    }
                    
                    const data = await response.json();
                    
                    if (data.candidates && data.candidates.length > 0) {
                        // Increment usage counter on successful call
                        rate_limiter.increment_usage();
                        
                        const generated_text = data.candidates[0].content.parts[0].text;
                        return generated_text.trim();
                    } else {
                        throw new Error('×œ× ×”×ª×§×‘×œ×” ×ª×©×•×‘×” ××”×©×™×¨×•×ª');
                    }
                    
                } catch (error) {
                    console.error('Gemini API error:', error);
                    
                    // Fallback to mock API for development
                    console.log('Falling back to mock API...');
                    return await mock_claude_api.complete(prompt);
                }
            }
        };

        // Mock Claude API for development fallback
        const mock_claude_api = {
            complete: async (prompt) => {
                // Simulate API delay
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Extract information from prompt for personalization
                const extract_info_from_prompt = (prompt) => {
                    const name_match = prompt.match(/×©×:\s*([^\n\r]+)/);
                    const age_match = prompt.match(/×’×™×œ:\s*([^\n\r]+)/);
                    const recipient_gender_match = prompt.match(/××™×Ÿ ××§×‘×œ ×”×‘×¨×›×”:\s*([^\n\r]+)/);
                    const sender_gender_match = prompt.match(/××™×Ÿ ×›×•×ª×‘ ×”×‘×¨×›×”:\s*([^\n\r]+)/);
                    const relationship_match = prompt.match(/×”×§×©×¨:\s*([^\n\r]+)/);
                    const tone_match = prompt.match(/×‘×˜×•×Ÿ\s*([^\.\n\r]+)/);
                    const personal_match = prompt.match(/×¤×¨×˜×™× ××™×©×™×™×:\s*([^\n\r]+)/);
                    const notes_match = prompt.match(/×”×¢×¨×•×ª × ×•×¡×¤×•×ª:\s*([^\n\r]+)/);
                    
                    return {
                        name: name_match ? name_match[1].trim() : '',
                        age: age_match ? age_match[1].trim() : '',
                        recipientGender: recipient_gender_match ? recipient_gender_match[1].trim() : '',
                        senderGender: sender_gender_match ? sender_gender_match[1].trim() : '',
                        relationship: relationship_match ? relationship_match[1].trim() : '',
                        tone: tone_match ? tone_match[1].trim() : '',
                        personalDetails: personal_match ? personal_match[1].trim() : '',
                        additionalNotes: notes_match ? notes_match[1].trim() : ''
                    };
                };

                const info = extract_info_from_prompt(prompt);
                
                // Helper function to get gender-appropriate text for recipient
                const get_recipient_forms = (gender) => {
                    const is_male = gender === '×–×›×¨';
                    return {
                        dear: is_male ? '×™×§×¨' : '×™×§×¨×”',
                        you: is_male ? '××ª×”' : '××ª',
                        beautiful: is_male ? '× ×”×“×¨' : '× ×”×“×¨×ª',
                        skilled: is_male ? '××•×›×©×¨' : '××•×›×©×¨×ª',
                        beloved: is_male ? '××”×•×‘' : '××”×•×‘×”',
                        brings: is_male ? '××‘×™×' : '××‘×™××”',
                        continue: is_male ? '×ª××©×™×š' : '×ª××©×™×›×™',
                        special: is_male ? '×”××™×•×—×“' : '×”××™×•×—×“×ª',
                        surrounded: is_male ? '××•×§×£' : '××•×§×¤×ª',
                        getMarried: is_male ? '×ª×ª×—×ª×Ÿ' : '×ª×ª×—×ª× ×™',
                        grandpa: is_male ? '×¡×‘×' : '×¡×‘×ª×',
                        helper: is_male ? '×¢×•×–×¨' : '×¢×•×–×¨×ª',
                        receive: is_male ? '×ª×§×‘×œ' : '×ª×§×‘×œ×™',
                        shaper: is_male ? '××¢×¦×‘' : '××¢×¦×‘×ª',
                        doer: is_male ? '×¢×•×©×”' : '×¢×•×©×”',
                        friend: is_male ? '×—×‘×¨' : '×—×‘×¨×”',
                        sibling: is_male ? '××—' : '××—×•×ª',
                        colleague: is_male ? '×¢××™×ª' : '×¢××™×ª×”',
                        doctor: is_male ? '×¨×•×¤×' : '×¨×•×¤××”',
                        teacher: is_male ? '××•×¨×”' : '××•×¨×”'
                    };
                };

                // Helper function to get gender-appropriate text for sender
                const get_sender_forms = (gender) => {
                    const is_male = gender === '×–×›×¨';
                    return {
                        wish: is_male ? '×××—×œ' : '×××—×œ×ª',
                        found: is_male ? '××¦××ª×™' : '××¦××ª×™', // Same for both
                        think: is_male ? '×—×•×©×‘' : '×—×•×©×‘×ª',
                        remember: is_male ? '×–×•×›×¨' : '×–×•×›×¨×ª',
                        hope: is_male ? '××§×•×•×”' : '××§×•×•×”', // Same for both
                        believe: is_male ? '××××™×Ÿ' : '××××™× ×”',
                        happy: is_male ? '×©××—' : '×©××—×”',
                        proud: is_male ? '×’××”' : '×’××”', // Same for both
                        excited: is_male ? '××ª×¨×’×©' : '××ª×¨×’×©×ª',
                        blessed: is_male ? '××‘×•×¨×š' : '××‘×•×¨×›×ª',
                        write: is_male ? '×›×•×ª×‘' : '×›×•×ª×‘×ª',
                        send: is_male ? '×©×•×œ×—' : '×©×•×œ×—×ª',
                        congratulate: is_male ? '××‘×¨×š' : '××‘×¨×›×ª'
                    };
                };

                // Generate personalized response based on event type and extracted info
                const generate_personalized_greeting = (event_type, info) => {
                    let greeting = '';
                    const name = info.name || (info.recipientGender === '×–×›×¨' ? '×™×§×¨' : '×™×§×¨×”');
                    const tone = info.tone || '';
                    const recipient_forms = get_recipient_forms(info.recipientGender);
                    const sender_forms = get_sender_forms(info.senderGender);
                    const is_recipient_male = info.recipientGender === '×–×›×¨';
                    
                    // Base greeting by event type
                    if (event_type.includes('×™×•× ×”×•×œ×“×ª')) {
                        if (tone.includes('××¦×—×™×§')) {
                            greeting = `${name} ×”${recipient_forms.dear}, ×¢×•×“ ×©× ×” ×¢×‘×¨×” ×•${recipient_forms.you} ×¢×“×™×™×Ÿ ${recipient_forms.beautiful}! ××–×œ ×˜×•×‘ ×¢×œ ×™×•× ×”×”×•×œ×“×ª. ×× ×™ ${sender_forms.wish} ×œ×š ×©×”×©× ×” ×”×‘××” ×ª×‘×™× ×”×¨×‘×” ×¦×—×•×§, ××•×©×¨ ×•××•×œ×™ ×§×¦×ª ×¤×—×•×ª × ×¨×•×ª ×¢×œ ×”×¢×•×’×”!`;
                        } else if (tone.includes('×¨×©××™')) {
                            greeting = `×œ×›×‘×•×“ ${name}, ×‘×”×’×™×¢ ×™×•× ×”×•×œ×“×ª×š ×”× × ×™ ${sender_forms.write} ×œ×”×‘×™×¢ ×œ×š ××ª ×‘×¨×›×•×ª×™×™ ×”×›× ×•×ª. ×× ×™ ${sender_forms.wish} ×©×ª×–×›×” ×œ×©× ×™× ×¨×‘×•×ª ×•× ×¢×™××•×ª ××œ××•×ª ×‘×¨×™××•×ª ×•××•×©×¨.`;
                        } else if (tone.includes('×¨×’×©×™')) {
                            greeting = `${name} ×”${recipient_forms.beloved}, ×™×•× ×”×•×œ×“×ª×š ×”×•× ×™×•× ××™×•×—×“ ×¢×‘×•×¨ ×›×œ ××™ ×©××•×”×‘ ××•×ª×š. ${recipient_forms.you} ${recipient_forms.brings} ×›×œ ×›×š ×”×¨×‘×” ××•×¨ ×œ×—×™×™× ×©×œ ×”×× ×©×™× ×¡×‘×™×‘×š. ×× ×™ ${sender_forms.happy} ${sender_forms.congratulate} ××•×ª×š ×•×©${recipient_forms.continue} ×œ×”×™×•×ª ×”×“××•×ª ${recipient_forms.special} ×©${recipient_forms.you}!`;
                        } else {
                            greeting = `××–×œ ×˜×•×‘ ${name} ×¢×œ ×™×•× ×”×•×œ×“×ª×š! ×× ×™ ${sender_forms.wish} ×©×ª×–×›×” ×œ×©× ×” ××œ××” ×‘×‘×¨×™××•×ª, ××•×©×¨ ×•×”×¦×œ×—×”. ×©×›×œ ×—×œ×•××•×ª×™×š ×™×ª×’×©××• ×•×©${recipient_forms.continue} ×œ×©××— ××ª ×›×œ ×”×¡×•×‘×‘×™× ××•×ª×š.`;
                        }
                    } else if (event_type.includes('×—×ª×•× ×”')) {
                        if (tone.includes('××¦×—×™×§')) {
                            greeting = `${name}, ×”×’×™×¢ ×”×–××Ÿ! ××—×¨×™ ×›×œ ×”×©× ×™× ×©×œ "××ª×™ ${recipient_forms.getMarried}?" ×¡×•×£ ×¡×•×£! ×× ×™ ${sender_forms.happy} ${sender_forms.congratulate} ××•×ª×š ×¢×œ ×”×—×ª×•× ×”. ×©×ª××™×“ ×ª×–×›×¨×• ×©×”××™×œ×™× ×”×›×™ ×—×©×•×‘×•×ª ×‘× ×™×©×•××™×Ÿ ×”×Ÿ "${recipient_forms.you} ${is_recipient_male ? '×¦×•×“×§' : '×¦×•×“×§×ª'} ×™×§×™×¨×™!"`;
                        } else if (tone.includes('×¨×©××™')) {
                            greeting = `×œ×›×‘×•×“ ${name}, ×‘×”×–×“×× ×•×ª × ×™×©×•××™×›× ×× ×™ ${sender_forms.write} ×œ×”×‘×™×¢ ××ª ×‘×¨×›×•×ª×™×™ ×”×›× ×•×ª. ×× ×™ ${sender_forms.wish} ×©×ª×–×›×• ×œ×—×™×™× ××©×•×ª×¤×™× ××œ××™ ××”×‘×”, ×”×‘× ×” ×•××•×©×¨.`;
                        } else {
                            greeting = `××–×œ ×˜×•×‘ ${name} ×¢×œ × ×™×©×•××™×š! ×× ×™ ${sender_forms.wish} ×©×ª×–×›×• ×œ×‘×™×ª × ×××Ÿ ×‘×™×©×¨××œ, ××œ× ×‘××”×‘×”, ×›×‘×•×“ ×”×“×“×™ ×•××•×©×¨ ×××™×ª×™. ×©×ª×‘× ×• ×™×—×“ ×¢×ª×™×“ ××–×”×™×¨ ×•××œ× ×‘×¨×›×”.`;
                        }
                    } else if (event_type.includes('× ×›×“ ×—×“×©') || event_type.includes('× ×›×“×” ×—×“×©×”')) {
                        if (tone.includes('××¦×—×™×§')) {
                            greeting = `${name}, ××–×œ ×˜×•×‘ ×¢×œ ×”× ×›×“ ×”×—×“×©! ×¢×›×©×™×• ${recipient_forms.you} ×¨×©××™×ª ${recipient_forms.grandpa} - ×–×” ××•××¨ ×©××¤×©×¨ ×œ×¤× ×§ ×‘×œ×™ ××•×¡×¨ ×•×œ×”×—×–×™×¨ ×”×‘×™×ª×”! ×× ×™ ${sender_forms.excited} ×‘×©×‘×™×œ×š ×œ×§×¨××ª ×”×›×™×£ ×”×’×“×•×œ ×”×–×”.`;
                        } else if (tone.includes('×¨×’×©×™')) {
                            greeting = `${name} ×”${recipient_forms.dear}, ××™×–×” ×¨×’×© ××ª×•×§ ×•××™×•×—×“! × ×›×“ ×—×“×© ×–×” ×œ× ×¨×§ ×ª×™× ×•×§, ×–×” ×”××©×š ×”×“×¨×š, ×—×•×œ×™×” × ×•×¡×¤×ª ×‘×©×¨×©×¨×ª ×”××”×‘×” ×©×œ×›×. ×× ×™ ${sender_forms.happy} ×‘×©×‘×™×œ×›× ×•${sender_forms.wish} ×©×ª×–×›×• ×œ×”×™×•×ª ${recipient_forms.grandpa} ${is_recipient_male ? '×’××”' : '×’××”'} ×•×œ×¨××•×ª ××•×ª×• ×’×“×œ ×•×¤×•×¨×—.`;
                        } else {
                            greeting = `××–×œ ×˜×•×‘ ${name} ×¢×œ ×”× ×›×“ ×”×—×“×©! ××™×–×” ×©××—×” ×’×“×•×œ×” ×•××™×•×—×“×ª. ×× ×™ ${sender_forms.wish} ×©×ª×–×›×• ×œ×¨××•×ª ××•×ª×• ×’×“×œ ×•××ª×¤×ª×—, ×•×©×ª×”×™×• ${recipient_forms.grandpa} ${is_recipient_male ? '×’××”' : '×’××”'} ×•××•×”×‘×™×. ×‘×¨×›×•×ª ×œ×›×œ ×”××©×¤×—×”!`;
                        }
                    } else if (event_type.includes('×¢×œ×™×” ×œ××¨×¥')) {
                        greeting = `${name}, ×‘×¨×•×›×™× ×”×‘××™× ×”×‘×™×ª×”! ×¢×œ×™×” ×œ××¨×¥ ×”×™× ×”×ª×’×©××•×ª ×—×œ×•×. ×× ×™ ${sender_forms.excited} ×‘×©×‘×™×œ×›× ×•${sender_forms.wish} ×©×ª×§×œ×˜×• ×‘×§×œ×•×ª, ×ª××¦××• ××ª ××§×•××›× ×•×ª×”× ×• ××›×œ ×”×˜×•×‘ ×©×™×© ×œ××¨×¥ ×œ×”×¦×™×¢. ×‘×”×¦×œ×—×” ×‘××¡×¢ ×”×—×“×©!`;
                    } else {
                        greeting = `××–×œ ×˜×•×‘ ${name}! ×× ×™ ${sender_forms.wish} ×©×ª××™×“ ×ª×”×™×” ${recipient_forms.surrounded} ×‘××”×‘×” ×•×‘×©××—×”. ×©×›×œ ×”×˜×•×‘ ×‘×¢×•×œ× ×™×’×™×¢ ××œ×™×š ×•×ª××™×“ ×ª××¦× ×¡×™×‘×•×ª ×œ×—×™×™×š.`;
                    }
                    
                    // Add personal details if provided
                    if (info.personalDetails) {
                        if (info.personalDetails.includes('×¨×•×¤×') || info.personalDetails.includes('×¨×•×¤××”')) {
                            greeting += ` ×›${recipient_forms.doctor} ${recipient_forms.skilled}, ${recipient_forms.you} ${recipient_forms.helper} ×œ×›×œ ×›×š ×”×¨×‘×” ×× ×©×™× - ×× ×™ ${sender_forms.think} ×©×”×’×™×¢ ×”×–××Ÿ ×©×’× ${recipient_forms.you} ${recipient_forms.receive} ×—×–×¨×” ××ª ×›×œ ×”×˜×•×‘ ×”×–×”.`;
                        } else if (info.personalDetails.includes('××•×¨×”')) {
                            greeting += ` ×”××§×¦×•×¢ ×©×œ×š ×›${recipient_forms.teacher} ×”×•× ××§×¦×•×¢ ×§×“×•×© - ${recipient_forms.you} ${recipient_forms.shaper} ××ª ×”×¢×ª×™×“. ×× ×™ ${sender_forms.wish} ×œ×”×•×“×•×ª ×œ×š ×¢×œ ×›×œ ××” ×©${recipient_forms.you} ${recipient_forms.doer}.`;
                        } else if (info.personalDetails.includes('××•×¡×™×§×”') || info.personalDetails.includes('× ×’×™× ×”')) {
                            greeting += ` ×›××• ×©${recipient_forms.you} ${recipient_forms.brings} ××•×¡×™×§×” ×™×¤×” ×œ×¢×•×œ×, ×× ×™ ${sender_forms.believe} ×©×”×—×™×™× ×©×œ×š ××œ××™× ×‘××œ×•×“×™×•×ª ××ª×•×§×•×ª.`;
                        }
                    }
                    
                    // Add relationship context
                    if (info.relationship) {
                        if (info.relationship.includes('××—') || info.relationship.includes('××—×•×ª')) {
                            greeting += ` ×× ×™ ${sender_forms.proud} ×©×™×© ×œ×™ ${recipient_forms.sibling} ×›××•×š!`;
                        } else if (info.relationship.includes('×—×‘×¨')) {
                            greeting += ` ××™×–×” ××–×œ ×©×™×© ×œ×™ ${recipient_forms.friend} ×›××•×š ×‘×—×™×™×! ×× ×™ ${sender_forms.blessed} ×‘×—×‘×¨×•×ª ×”×–×•.`;
                        } else if (info.relationship.includes('×¢××™×ª')) {
                            greeting += ` ×”×¢×‘×•×“×” ××™×ª×š ×”×™× ×ª××™×“ ×”× ××”! ×× ×™ ${sender_forms.happy} ×©×× ×—× ×• ×¢××™×ª×™×.`;
                        }
                    }
                    
                    return greeting;
                };
                
                // Determine event type from prompt
                let event_type = '';
                if (prompt.includes('×™×•× ×”×•×œ×“×ª')) event_type = '×™×•× ×”×•×œ×“×ª';
                else if (prompt.includes('×—×ª×•× ×”')) event_type = '×—×ª×•× ×”';
                else if (prompt.includes('× ×›×“ ×—×“×©') || prompt.includes('× ×›×“×” ×—×“×©×”')) event_type = '× ×›×“ ×—×“×©';
                else if (prompt.includes('×¢×œ×™×” ×œ××¨×¥')) event_type = '×¢×œ×™×” ×œ××¨×¥';
                else if (prompt.includes('×‘×¨ ××¦×•×•×”') || prompt.includes('×‘×ª ××¦×•×•×”')) event_type = '×‘×¨ ××¦×•×•×”';
                else event_type = '×›×œ×œ×™';
                
                return generate_personalized_greeting(event_type, info);
            }
        };

        // Initialize API - use Gemini API with fallback to mock
        if (typeof window.claude === 'undefined') {
            window.claude = gemini_api;
        }

        const GreetingCardGenerator = () => {
            const [formData, setFormData] = useState({
                eventType: '',
                customEventType: '',
                recipientName: '',
                recipientAge: '',
                recipientGender: '',
                senderGender: '',
                relationship: '',
                personalDetails: '',
                tone: [],
                additionalNotes: ''
            });
            
            const [generatedCard, setGeneratedCard] = useState(null);
            const [isGenerating, setIsGenerating] = useState(false);
            const [errorMessage, setErrorMessage] = useState('');
            const [isImproving, setIsImproving] = useState(false);
            const [improvedCards, setImprovedCards] = useState({});

            const event_types = [
                { value: 'birthday', label: '×™×•× ×”×•×œ×“×ª', icon: 'ğŸ‚' },
                { value: 'wedding', label: '×—×ª×•× ×”', icon: 'ğŸ’’' },
                { value: 'barmitzvah', label: '×‘×¨/×‘×ª ××¦×•×•×”', icon: 'ğŸ“œ' },
                { value: 'engagement', label: '××™×¨×•×¡×™×Ÿ', icon: 'ğŸ’' },
                { value: 'graduation', label: '×¡×™×•× ×œ×™××•×“×™×', icon: 'ğŸ“' },
                { value: 'newjob', label: '×¢×‘×•×“×” ×—×“×©×”', icon: 'ğŸ’¼' },
                { value: 'holiday', label: '×—×’', icon: 'âœ¨' },
                { value: 'anniversary', label: '×™×•× × ×™×©×•××™×Ÿ', icon: 'â¤ï¸' },
                { value: 'custom', label: '××™×¨×•×¢ ××—×¨', icon: 'ğŸ‰' }
            ];

            const tones = [
                { value: 'warm', label: '×—× ×•××™×©×™' },
                { value: 'funny', label: '××¦×—×™×§' },
                { value: 'formal', label: '×¨×©××™' },
                { value: 'emotional', label: '×¨×’×©×™' },
                { value: 'casual', label: '×§×œ×™×œ' }
            ];

            const genders = [
                { value: 'male', label: '×–×›×¨' },
                { value: 'female', label: '× ×§×‘×”' }
            ];

            // No localStorage persistence - always start fresh

            const handleInputChange = useCallback((field, value) => {
                setFormData(prev => ({
                    ...prev,
                    [field]: value
                }));
                setErrorMessage(''); // Clear error when user starts typing
            }, []);

            const validateForm = useCallback(() => {
                if (!formData.eventType) {
                    setErrorMessage('×× × ×‘×—×¨ ×¡×•×’ ××™×¨×•×¢');
                    return false;
                }
                if (formData.eventType === 'custom' && !formData.customEventType.trim()) {
                    setErrorMessage('×× × ×¤×¨×˜ ××ª ×¡×•×’ ×”××™×¨×•×¢');
                    return false;
                }
                if (!formData.recipientName.trim()) {
                    setErrorMessage('×× × ×”×›× ×¡ ×©× ××§×‘×œ ×”×‘×¨×›×”');
                    return false;
                }
                if (!formData.tone.length) {
                    setErrorMessage('×× × ×‘×—×¨ ×œ×¤×—×•×ª ×˜×•×Ÿ ××—×“ ×œ×‘×¨×›×”');
                    return false;
                }
                if (!formData.recipientGender) {
                    setErrorMessage('×× × ×‘×—×¨ ××™×Ÿ ××§×‘×œ ×”×‘×¨×›×”');
                    return false;
                }
                if (!formData.senderGender) {
                    setErrorMessage('×× × ×‘×—×¨ ××ª ×”××™×Ÿ ×©×œ×š (×›×•×ª×‘ ×”×‘×¨×›×”)');
                    return false;
                }
                return true;
            }, [formData]);

            const generate_greeting = async () => {
                if (!validateForm()) {
                    return;
                }

                setIsGenerating(true);
                setErrorMessage('');
                
                try {
                    const selectedEvent = event_types.find(e => e.value === formData.eventType);
                    const selectedTones = formData.tone.map(t => tones.find(tone => tone.value === t).label);
                    const selectedRecipientGender = genders.find(g => g.value === formData.recipientGender);
                    const selectedSenderGender = genders.find(g => g.value === formData.senderGender);
                    
                    // Determine event name for prompt
                    const eventName = formData.eventType === 'custom' 
                        ? formData.customEventType 
                        : selectedEvent.label;
                    
                    const prompt = `
                    ×¦×•×¨ ×‘×¨×›×” ××•×ª×××ª ××™×©×™×ª ×¢×‘×•×¨ ${eventName} ×‘×˜×•×Ÿ ${selectedTones.join(' ×•')}.
                    
                    ×¤×¨×˜×™ ××§×‘×œ ×”×‘×¨×›×”:
                    - ×©×: ${formData.recipientName}
                    - ××™×Ÿ ××§×‘×œ ×”×‘×¨×›×”: ${selectedRecipientGender.label}
                    ${formData.recipientAge ? `- ×’×™×œ: ${formData.recipientAge}` : ''}
                    ${formData.relationship ? `- ×”×§×©×¨: ${formData.relationship}` : ''}
                    
                    ×¤×¨×˜×™ ×›×•×ª×‘ ×”×‘×¨×›×”:
                    - ××™×Ÿ ×›×•×ª×‘ ×”×‘×¨×›×”: ${selectedSenderGender.label}
                    
                    ${formData.personalDetails ? `×¤×¨×˜×™× ××™×©×™×™×: ${formData.personalDetails}` : ''}
                    
                    ${formData.additionalNotes ? `×”×¢×¨×•×ª × ×•×¡×¤×•×ª: ${formData.additionalNotes}` : ''}
                    
                    ×”× ×—×™×•×ª ×—×©×•×‘×•×ª:
                    - ×›×ª×•×‘ ×‘×¢×‘×¨×™×ª ×‘×œ×‘×“
                    - ×¦×•×¨ ×‘×¨×›×” ×× ×•×©×™×ª ×•×˜×‘×¢×™×” ×©×œ× × ×©××¢×ª ××œ××›×•×ª×™×ª
                    - ×”×©×ª××© ×‘×‘×™×˜×•×™×™× ×™×©×¨××œ×™×™× ×˜×‘×¢×™×™×
                    - ×”×™×× ×¢ ××‘×™×˜×•×™×™× ×§×œ×™×©××ª×™×™× ××• ×’× ×¨×™×™×
                    - ×”×ª×× ××ª ×”××•×¨×š ×œ×¡×•×’ ×”××™×¨×•×¢ (2-4 ××©×¤×˜×™×)
                    - ×”×§×¤×“ ×¢×œ ×˜×•×Ÿ ${selectedTones.join(' ×•')}
                    - ×©×œ×‘ ××ª ×”×¤×¨×˜×™× ×”××™×©×™×™× ×‘×¦×•×¨×” ×—×œ×§×”
                    - ×”×©×ª××© ×‘×¦×•×¨×ª ×”×¤× ×™×™×” ×”××ª××™××” ×œ××™×Ÿ ×”××§×‘×œ (×–×›×¨/× ×§×‘×”) - ×œ×“×•×’××”: "××ª×”/××ª", "×™×§×¨/×™×§×¨×”", "××•×›×©×¨/××•×›×©×¨×ª"
                    - ×”×©×ª××© ×‘×¦×•×¨×ª ×“×™×‘×•×¨ ×”××ª××™××” ×œ××™×Ÿ ×›×•×ª×‘ ×”×‘×¨×›×” (×–×›×¨/× ×§×‘×”) - ×œ×“×•×’××”: "×× ×™ ×××—×œ/×××—×œ×ª", "×× ×™ ×—×•×©×‘/×—×•×©×‘×ª", "×× ×™ ×©××—/×©××—×”"
                    ${formData.eventType === 'custom' ? `- ×”×ª×× ××ª ×”×‘×¨×›×” ×¡×¤×¦×™×¤×™×ª ×œ××™×¨×•×¢ "${formData.customEventType}"` : ''}
                    
                    ×”×—×–×¨ ×¨×§ ××ª ×˜×§×¡×˜ ×”×‘×¨×›×”, ×œ×œ× ×”×¡×‘×¨×™× ××• ×”×¢×¨×•×ª × ×•×¡×¤×•×ª.
                    `;

                    const response = await window.claude.complete(prompt);
                    
                    const cardData = {
                        text: response,
                        eventType: formData.eventType,
                        customEventType: formData.customEventType,
                        recipientName: formData.recipientName,
                        eventIcon: selectedEvent.icon,
                        eventName: eventName,
                        createdAt: new Date().toISOString()
                    };

                    setGeneratedCard(cardData);
                    
                    // Save generated card to localStorage
                    try {
                        const savedCards = JSON.parse(localStorage.getItem('generated_cards') || '[]');
                        savedCards.push(cardData);
                        // Keep only last 10 cards
                        if (savedCards.length > 10) {
                            savedCards.splice(0, savedCards.length - 10);
                        }
                        localStorage.setItem('generated_cards', JSON.stringify(savedCards));
                    } catch (error) {
                        console.error('Failed to save generated card:', error);
                    }
                    
                } catch (error) {
                    console.error('×©×’×™××” ×‘×™×¦×™×¨×ª ×”×‘×¨×›×”:', error);
                    setErrorMessage('××™×¨×¢×” ×©×’×™××” ×‘×™×¦×™×¨×ª ×”×‘×¨×›×”. ×× × × ×¡×” ×©×•×‘.');
                } finally {
                    setIsGenerating(false);
                }
            };

            const getCardBackground = useMemo(() => {
                const backgrounds = {
                    birthday: 'bg-gradient-to-br from-pink-400 via-purple-400 to-indigo-400',
                    wedding: 'bg-gradient-to-br from-rose-300 via-pink-300 to-red-300',
                    barmitzvah: 'bg-gradient-to-br from-blue-400 via-indigo-400 to-purple-400',
                    engagement: 'bg-gradient-to-br from-yellow-300 via-orange-300 to-red-300',
                    graduation: 'bg-gradient-to-br from-green-400 via-teal-400 to-blue-400',
                    newjob: 'bg-gradient-to-br from-gray-400 via-slate-400 to-zinc-400',
                    holiday: 'bg-gradient-to-br from-amber-400 via-yellow-400 to-orange-400',
                    anniversary: 'bg-gradient-to-br from-red-400 via-rose-400 to-pink-400'
                };
                return (eventType) => backgrounds[eventType] || 'bg-gradient-to-br from-blue-400 to-purple-400';
            }, []);

            const improveGreetingForPlatform = useCallback(async (platform) => {
                if (!generatedCard) return;
                
                setIsImproving(true);
                setErrorMessage('');
                
                try {
                    const senderGender = genders.find(g => g.value === formData.senderGender);
                    const senderForms = {
                        want: senderGender.label === '×–×›×¨' ? '×¨×•×¦×”' : '×¨×•×¦×”', // Same for both
                        improve: senderGender.label === '×–×›×¨' ? '×œ×©×¤×¨' : '×œ×©×¤×¨', // Same for both
                        adapt: senderGender.label === '×–×›×¨' ? '×œ×”×ª××™×' : '×œ×”×ª××™×' // Same for both
                    };
                    
                    const platformInstructions = {
                        whatsapp: {
                            name: 'WhatsApp',
                            format: '- ×”×•×¡×£ ×××•×’\'×™× ×¨×œ×•×•× ×˜×™×™×\n- ×§×¦×¨ ×™×•×ª×¨ ×œ××¡×¨×•×Ÿ\n- ×™×•×ª×¨ ××™×©×™ ×•×—×‘×¨×•×ª×™\n- ×”×©×ª××© ×‘×©×¤×” ×™×•××™×•××™×ª ×•×¤×©×•×˜×”'
                        },
                        facebook: {
                            name: 'Facebook',
                            format: '- ×”×•×¡×£ hashtags ×¨×œ×•×•× ×˜×™×™× ×‘×¢×‘×¨×™×ª\n- ××ª××™× ×œ×¤×¨×¡×•× ×¤×•××‘×™\n- ×™×•×ª×¨ ×¤×•×¨××œ×™ ×•××¢×•×¦×‘\n- × ×™×ª×Ÿ ×œ×”×•×¡×™×£ ×§×¨×™××” ×œ×¤×¢×•×œ×” (×œ×™×™×§×™×, ×ª×’×•×‘×•×ª)'
                        }
                    };
                    
                    const platformConfig = platformInstructions[platform];
                    
                    const improvementPrompt = `
                    ×§×— ××ª ×”×‘×¨×›×” ×”×‘××” ×•×”×ª×× ××•×ª×” ×œ${platformConfig.name}:
                    
                    "${generatedCard.text}"
                    
                    ×”× ×—×™×•×ª ×œ×”×ª×××” ×œ${platformConfig.name}:
                    ${platformConfig.format}
                    
                    ×”× ×—×™×•×ª ×›×œ×œ×™×•×ª:
                    - ×©××•×¨ ×¢×œ ×”××¡×¨ ×”××§×•×¨×™ ×•×”×˜×•×Ÿ
                    - ×›×ª×•×‘ ×‘×¢×‘×¨×™×ª ×‘×œ×‘×“
                    - ×”×ª×× ×œ×¤×œ×˜×¤×•×¨××” ${platformConfig.name}
                    - ×©××•×¨ ×¢×œ ×”×“×§×“×•×§ ×”× ×›×•×Ÿ (×–×›×¨/× ×§×‘×”)
                    - ××œ ×ª×•×¡×™×£ ×”×¡×‘×¨×™× - ×¨×§ ××ª ×”×‘×¨×›×” ×”××•×ª×××ª
                    
                    ×”×—×–×¨ ×¨×§ ××ª ×”×‘×¨×›×” ×”××•×ª×××ª ×œ${platformConfig.name}.
                    `;

                    const improvedText = await window.claude.complete(improvementPrompt);
                    
                    setImprovedCards(prev => ({
                        ...prev,
                        [platform]: improvedText
                    }));
                    
                } catch (error) {
                    console.error('×©×’×™××” ×‘×©×™×¤×•×¨ ×”×‘×¨×›×”:', error);
                    setErrorMessage('××™×¨×¢×” ×©×’×™××” ×‘×©×™×¤×•×¨ ×”×‘×¨×›×”. ×× × × ×¡×” ×©×•×‘.');
                } finally {
                    setIsImproving(false);
                }
            }, [generatedCard, formData.senderGender]);

            const resetForm = useCallback(() => {
                setFormData({
                    eventType: '',
                    customEventType: '',
                    recipientName: '',
                    recipientAge: '',
                    recipientGender: '',
                    senderGender: '',
                    relationship: '',
                    personalDetails: '',
                    tone: [],
                    additionalNotes: ''
                });
                setGeneratedCard(null);
                setImprovedCards({});
                setErrorMessage('');
            }, []);

            const handleShare = useCallback(async () => {
                try {
                    if (navigator.share) {
                        await navigator.share({
                            title: '×›×¨×˜×™×¡ ×‘×¨×›×”',
                            text: generatedCard.text
                        });
                    } else {
                        await navigator.clipboard.writeText(generatedCard.text);
                        alert('×”×‘×¨×›×” ×”×•×¢×ª×§×” ×œ×œ×•×—');
                    }
                } catch (error) {
                    console.error('Share failed:', error);
                    // Fallback to manual copy
                    try {
                        await navigator.clipboard.writeText(generatedCard.text);
                        alert('×”×‘×¨×›×” ×”×•×¢×ª×§×” ×œ×œ×•×—');
                    } catch (clipboardError) {
                        console.error('Clipboard failed:', clipboardError);
                        alert('×œ× × ×™×ª×Ÿ ×œ×©×ª×£ ××• ×œ×”×¢×ª×™×§ ××ª ×”×‘×¨×›×”');
                    }
                }
            }, [generatedCard]);

            const download_card_as_image = async () => {
                try {
                    // Create a canvas
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Set canvas size (card proportions)
                    canvas.width = CONSTANTS.CANVAS.WIDTH;
                    canvas.height = CONSTANTS.CANVAS.HEIGHT;
                    
                    // Get the card's background gradient
                    const gradient_backgrounds = {
                        birthday: ['#f472b6', '#a855f7', '#6366f1'],
                        wedding: ['#fb7185', '#f9a8d4', '#ef4444'],
                        barmitzvah: ['#60a5fa', '#8b5cf6', '#a855f7'],
                        engagement: ['#fde047', '#fb923c', '#ef4444'],
                        graduation: ['#4ade80', '#14b8a6', '#3b82f6'],
                        newjob: ['#9ca3af', '#64748b', '#52525b'],
                        holiday: ['#f59e0b', '#eab308', '#f97316'],
                        anniversary: ['#ef4444', '#f43f5e', '#ec4899']
                    };
                    
                    const event_colors = gradient_backgrounds[generatedCard.eventType] || ['#3b82f6', '#8b5cf6'];
                    
                    // Create gradient background
                    const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
                    gradient.addColorStop(0, event_colors[0]);
                    gradient.addColorStop(0.5, event_colors[1]);
                    gradient.addColorStop(1, event_colors[2] || event_colors[1]);
                    
                    // Fill background with gradient
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // Draw white rounded rectangle for card content
                    const cardPadding = CONSTANTS.CANVAS.PADDING;
                    const cardX = cardPadding;
                    const cardY = cardPadding;
                    const cardWidth = canvas.width - (cardPadding * 2);
                    const cardHeight = canvas.height - (cardPadding * 2);
                    const borderRadius = CONSTANTS.CANVAS.BORDER_RADIUS;
                    
                    // Draw rounded rectangle background
                    ctx.fillStyle = CONSTANTS.COLORS.CARD_BG;
                    ctx.beginPath();
                    
                    // Manual rounded rectangle implementation for better browser support
                    ctx.moveTo(cardX + borderRadius, cardY);
                    ctx.lineTo(cardX + cardWidth - borderRadius, cardY);
                    ctx.quadraticCurveTo(cardX + cardWidth, cardY, cardX + cardWidth, cardY + borderRadius);
                    ctx.lineTo(cardX + cardWidth, cardY + cardHeight - borderRadius);
                    ctx.quadraticCurveTo(cardX + cardWidth, cardY + cardHeight, cardX + cardWidth - borderRadius, cardY + cardHeight);
                    ctx.lineTo(cardX + borderRadius, cardY + cardHeight);
                    ctx.quadraticCurveTo(cardX, cardY + cardHeight, cardX, cardY + cardHeight - borderRadius);
                    ctx.lineTo(cardX, cardY + borderRadius);
                    ctx.quadraticCurveTo(cardX, cardY, cardX + borderRadius, cardY);
                    ctx.closePath();
                    ctx.fill();
                    
                    // Set text properties for RTL Hebrew
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.direction = 'rtl';
                    
                    // Draw event icon (emoji)
                    ctx.font = CONSTANTS.FONTS.ICON;
                    ctx.fillStyle = '#333';
                    ctx.fillText(generatedCard.eventIcon, canvas.width / 2, cardY + 120);
                    
                    // Draw event title
                    ctx.font = CONSTANTS.FONTS.TITLE;
                    ctx.fillStyle = CONSTANTS.COLORS.TEXT_PRIMARY;
                    const eventTitle = generatedCard.eventType === 'custom' 
                        ? generatedCard.customEventType 
                        : event_types.find(e => e.value === generatedCard.eventType)?.label;
                    ctx.fillText(eventTitle, canvas.width / 2, cardY + 200);
                    
                    // Draw greeting text (multi-line)
                    ctx.font = CONSTANTS.FONTS.TEXT;
                    ctx.fillStyle = CONSTANTS.COLORS.TEXT_SECONDARY;
                    
                    // Split text into lines that fit the card width
                    const maxLineWidth = cardWidth - 80;
                    const lines = wrapText(ctx, generatedCard.text, maxLineWidth);
                    
                    // Draw each line
                    const lineHeight = CONSTANTS.CANVAS.LINE_HEIGHT;
                    const startY = cardY + 280;
                    
                    lines.forEach((line, index) => {
                        ctx.fillText(line, canvas.width / 2, startY + (index * lineHeight));
                    });
                    
                    // Convert canvas to blob and download
                    canvas.toBlob((blob) => {
                        const url = URL.createObjectURL(blob);
                        const download_link = document.createElement('a');
                        download_link.href = url;
                        download_link.download = `×›×¨×˜×™×¡-×‘×¨×›×”-${generatedCard.recipientName}-${new Date().toLocaleDateString('he-IL')}.png`;
                        document.body.appendChild(download_link);
                        download_link.click();
                        document.body.removeChild(download_link);
                        URL.revokeObjectURL(url);
                    }, 'image/png');
                    
                } catch (error) {
                    console.error('Download failed:', error);
                    alert('××™×¨×¢×” ×©×’×™××” ×‘×”×•×¨×“×ª ×”×›×¨×˜×™×¡. ×× × × ×¡×” ×©×•×‘.');
                }
            };
            
            // Helper function to wrap text
            const wrapText = useCallback((ctx, text, maxWidth) => {
                const words = text.split(' ');
                const lines = [];
                let currentLine = '';
                
                for (let i = 0; i < words.length; i++) {
                    const word = words[i];
                    const testLine = currentLine + word + ' ';
                    const testWidth = ctx.measureText(testLine).width;
                    
                    if (testWidth > maxWidth && currentLine !== '') {
                        lines.push(currentLine.trim());
                        currentLine = word + ' ';
                    } else {
                        currentLine = testLine;
                    }
                }
                
                if (currentLine.trim() !== '') {
                    lines.push(currentLine.trim());
                }
                
                return lines;
            }, []);


            const check_api_status = () => {
                const api_key = window.API_CONFIG && window.API_CONFIG.GEMINI_API_KEY !== 'YOUR_GEMINI_API_KEY_HERE' 
                                ? window.API_CONFIG.GEMINI_API_KEY : null;
                
                if (!api_key) {
                    return '×‘×¨×›×•×ª ×“××•×™×•×ª (Demo)';
                }
                
                const limit_check = rate_limiter.can_make_request();
                const remaining = limit_check.remaining;
                
                return `Google Gemini API (${remaining}/1500 × ×•×ª×¨×•)`;
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 hebrew-text">
                    <div className="max-w-4xl mx-auto">
                        <div className="text-center mb-8">
                            <div className="inline-flex items-center gap-2 mb-4">
                                <Sparkles className="text-purple-600" size={32} />
                                <h1 className="text-4xl font-bold text-gray-800">××—×•×œ×œ ×›×¨×˜×™×¡×™ ×‘×¨×›×”</h1>
                                <Sparkles className="text-purple-600" size={32} />
                            </div>
                            <p className="text-gray-600 text-lg">×¦×•×¨ ×›×¨×˜×™×¡×™ ×‘×¨×›×” ××•×ª×××™× ××™×©×™×ª ×œ×›×œ ××™×¨×•×¢</p>
                            <div className="text-sm text-gray-500 mt-2">
                                ×¡×˜×˜×•×¡: <span className="font-medium">{check_api_status()}</span>
                            </div>
                        </div>

                        {errorMessage && (
                            <div className="error-boundary mb-6">
                                <div className="flex items-center gap-2">
                                    <AlertCircle size={20} />
                                    <span>{errorMessage}</span>
                                </div>
                            </div>
                        )}

                        {!generatedCard ? (
                            <div className="bg-white rounded-2xl shadow-xl p-8">
                                <div className="grid md:grid-cols-2 gap-6">
                                    {/* ×¢××•×“×” ×¨××©×•× ×” */}
                                    <div className="space-y-6">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                ×¡×•×’ ×”××™×¨×•×¢ *
                                            </label>
                                            <div className="grid grid-cols-2 gap-2">
                                                {event_types.map(event => (
                                                    <button
                                                        key={event.value}
                                                        onClick={() => {
                                                            handle_input_change('eventType', event.value);
                                                            if (event.value !== 'custom') {
                                                                handle_input_change('customEventType', '');
                                                            }
                                                        }}
                                                        className={`p-3 rounded-lg border-2 transition-all flex items-center gap-2 text-sm ${
                                                            formData.eventType === event.value
                                                                ? 'border-purple-500 bg-purple-50 text-purple-700'
                                                                : 'border-gray-200 hover:border-purple-300'
                                                        }`}
                                                    >
                                                        <span>{event.icon}</span>
                                                        <span>{event.label}</span>
                                                    </button>
                                                ))}
                                            </div>
                                            
                                            {formData.eventType === 'custom' && (
                                                <div className="mt-4">
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                                        ×¤×¨×˜ ××ª ×¡×•×’ ×”××™×¨×•×¢ *
                                                    </label>
                                                    <input
                                                        type="text"
                                                        value={formData.customEventType}
                                                        onChange={(e) => handle_input_change('customEventType', e.target.value)}
                                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                                        placeholder="×œ×“×•×’××: × ×›×“ ×—×“×©, ×¢×œ×™×” ×œ××¨×¥, ×™×•× ×”×•×œ×“×ª 50..."
                                                    />
                                                </div>
                                            )}
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                ×©× ××§×‘×œ ×”×‘×¨×›×” *
                                            </label>
                                            <input
                                                type="text"
                                                value={formData.recipientName}
                                                onChange={(e) => handle_input_change('recipientName', e.target.value)}
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                                placeholder="×”×›× ×¡ ×©×..."
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                ×’×™×œ (××•×¤×¦×™×•× ×œ×™)
                                            </label>
                                            <input
                                                type="text"
                                                value={formData.recipientAge}
                                                onChange={(e) => handle_input_change('recipientAge', e.target.value)}
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                                placeholder="×œ×“×•×’××: 25, 30..."
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                ×”×§×©×¨ ××œ×™×š (××•×¤×¦×™×•× ×œ×™)
                                            </label>
                                            <input
                                                type="text"
                                                value={formData.relationship}
                                                onChange={(e) => handle_input_change('relationship', e.target.value)}
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                                placeholder="×œ×“×•×’××: ×—×‘×¨, ××—, ×¢××™×ª ×œ×¢×‘×•×“×”..."
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                ××™×Ÿ ××§×‘×œ ×”×‘×¨×›×” *
                                            </label>
                                            <div className="grid grid-cols-2 gap-2">
                                                {genders.map(gender => (
                                                    <button
                                                        key={gender.value}
                                                        onClick={() => handle_input_change('recipientGender', gender.value)}
                                                        className={`p-3 rounded-lg border-2 transition-all ${
                                                            formData.recipientGender === gender.value
                                                                ? 'border-purple-500 bg-purple-50 text-purple-700'
                                                                : 'border-gray-200 hover:border-purple-300'
                                                        }`}
                                                    >
                                                        {gender.label}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                ×”××™×Ÿ ×©×œ×š (×›×•×ª×‘ ×”×‘×¨×›×”) *
                                            </label>
                                            <div className="grid grid-cols-2 gap-2">
                                                {genders.map(gender => (
                                                    <button
                                                        key={gender.value}
                                                        onClick={() => handle_input_change('senderGender', gender.value)}
                                                        className={`p-3 rounded-lg border-2 transition-all ${
                                                            formData.senderGender === gender.value
                                                                ? 'border-blue-500 bg-blue-50 text-blue-700'
                                                                : 'border-gray-200 hover:border-blue-300'
                                                        }`}
                                                    >
                                                        {gender.label}
                                                    </button>
                                                ))}
                                            </div>
                                            <div className="text-xs text-gray-500 mt-1">
                                                × ×“×¨×© ×œ× ×™×¡×•×— ×“×§×“×•×§×™ × ×›×•×Ÿ (×× ×™ ×××—×œ/×××—×œ×ª)
                                            </div>
                                        </div>
                                    </div>

                                    {/* ×¢××•×“×” ×©× ×™×™×” */}
                                    <div className="space-y-6">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                ×˜×•×Ÿ ×”×‘×¨×›×” * (× ×™×ª×Ÿ ×œ×‘×—×•×¨ ×™×•×ª×¨ ×××—×“)
                                            </label>
                                            <div className="space-y-2">
                                                {tones.map(tone => (
                                                    <button
                                                        key={tone.value}
                                                        onClick={() => {
                                                            const currentTones = formData.tone;
                                                            const isSelected = currentTones.includes(tone.value);
                                                            if (isSelected) {
                                                                handleInputChange('tone', currentTones.filter(t => t !== tone.value));
                                                            } else {
                                                                handleInputChange('tone', [...currentTones, tone.value]);
                                                            }
                                                        }}
                                                        className={`w-full p-3 rounded-lg border-2 transition-all text-right ${
                                                            formData.tone.includes(tone.value)
                                                                ? 'border-purple-500 bg-purple-50 text-purple-700'
                                                                : 'border-gray-200 hover:border-purple-300'
                                                        }`}
                                                    >
                                                        {tone.label}
                                                    </button>
                                                ))}
                                            </div>
                                            {formData.tone.length > 0 && (
                                                <div className="mt-2 text-sm text-gray-600">
                                                    × ×‘×—×¨×•: {formData.tone.map(t => tones.find(tone => tone.value === t)?.label).join(', ')}
                                                </div>
                                            )}
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                ×¤×¨×˜×™× ××™×©×™×™× (××•×¤×¦×™×•× ×œ×™)
                                            </label>
                                            <textarea
                                                value={formData.personalDetails}
                                                onChange={(e) => handleInputChange('personalDetails', e.target.value)}
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent h-24 resize-none"
                                                placeholder="×ª×—×‘×™×‘×™×, ××§×¦×•×¢, ×–×™×›×¨×•× ×•×ª ××©×•×ª×¤×™×..."
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                ×”×¢×¨×•×ª × ×•×¡×¤×•×ª (××•×¤×¦×™×•× ×œ×™)
                                            </label>
                                            <textarea
                                                value={formData.additionalNotes}
                                                onChange={(e) => handleInputChange('additionalNotes', e.target.value)}
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent h-20 resize-none"
                                                placeholder="×œ×“×•×’××: ×”×§×¤×“ ×¢×œ ×‘×¨×›×” ×× ×•×©×™×ª, ×”×©×ª××© ×‘×‘×™×˜×•×™×™× ×™×©×¨××œ×™×™×..."
                                            />
                                        </div>
                                    </div>
                                </div>

                                <div className="mt-8 text-center">
                                    <button
                                        onClick={generate_greeting}
                                        disabled={isGenerating}
                                        className="bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-8 py-4 rounded-xl font-semibold text-lg shadow-lg hover:shadow-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 mx-auto"
                                    >
                                        {isGenerating ? (
                                            <>
                                                <div className="loading-spinner rounded-full h-5 w-5 border-b-2 border-white"></div>
                                                ×™×•×¦×¨ ×‘×¨×›×”...
                                            </>
                                        ) : (
                                            <>
                                                <Gift size={20} />
                                                ×¦×•×¨ ×›×¨×˜×™×¡ ×‘×¨×›×”
                                            </>
                                        )}
                                    </button>
                                </div>
                            </div>
                        ) : (
                            <div className="space-y-6">
                                {/* ×›×¨×˜×™×¡ ×”×‘×¨×›×” */}
                                <div className={`${getCardBackground(generatedCard.eventType)} p-8 rounded-2xl shadow-2xl`}>
                                    <div className="bg-white/90 backdrop-blur-sm p-8 rounded-xl text-center">
                                        <div className="text-6xl mb-4">{generatedCard.eventIcon}</div>
                                        <h2 className="text-2xl font-bold text-gray-800 mb-6">
                                            {generatedCard.eventType === 'custom' 
                                                ? generatedCard.customEventType 
                                                : event_types.find(e => e.value === generatedCard.eventType)?.label}
                                        </h2>
                                        <div className="text-lg leading-relaxed text-gray-700 whitespace-pre-wrap font-medium hebrew-text">
                                            {generatedCard.text}
                                        </div>
                                    </div>
                                </div>

                                {/* ×”×¦×¢×” ×œ×©×™×¤×•×¨ */}
                                {!improvedCards.whatsapp && !improvedCards.facebook && (
                                    <div className="bg-white/80 backdrop-blur-sm p-6 rounded-xl text-center border-2 border-dashed border-purple-300">
                                        <h3 className="text-lg font-semibold text-gray-800 mb-3">
                                            {formData.senderGender === 'male' ? '×¨×•×¦×”' : '×¨×•×¦×”'} ×œ×©×¤×¨ ××ª ×”×‘×¨×›×” ×•×œ×”×ª××™× ×œ×¤×œ×˜×¤×•×¨××•×ª?
                                        </h3>
                                        <p className="text-gray-600 mb-4">
                                            {formData.senderGender === 'male' ? '××•×›×œ' : '××•×›×œ'} ×œ×”×ª××™× ××ª ×”×‘×¨×›×” ×‘××™×•×—×“ ×œ-WhatsApp ××• Facebook
                                        </p>
                                        <div className="flex justify-center gap-3">
                                            <button
                                                onClick={() => improveGreetingForPlatform('whatsapp')}
                                                disabled={isImproving}
                                                className="bg-green-500 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2 hover:bg-green-600 transition-colors disabled:opacity-50"
                                            >
                                                {isImproving ? (
                                                    <div className="loading-spinner rounded-full h-4 w-4 border-b-2 border-white"></div>
                                                ) : (
                                                    <span>ğŸ“±</span>
                                                )}
                                                ×œ×”×ª××™× ×œ-WhatsApp
                                            </button>
                                            <button
                                                onClick={() => improveGreetingForPlatform('facebook')}
                                                disabled={isImproving}
                                                className="bg-blue-500 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2 hover:bg-blue-600 transition-colors disabled:opacity-50"
                                            >
                                                {isImproving ? (
                                                    <div className="loading-spinner rounded-full h-4 w-4 border-b-2 border-white"></div>
                                                ) : (
                                                    <span>ğŸ“˜</span>
                                                )}
                                                ×œ×”×ª××™× ×œ-Facebook
                                            </button>
                                        </div>
                                    </div>
                                )}

                                {/* ×‘×¨×›×•×ª ××©×•×¤×¨×•×ª */}
                                {(improvedCards.whatsapp || improvedCards.facebook) && (
                                    <div className="space-y-4">
                                        <h3 className="text-xl font-bold text-gray-800 text-center">×‘×¨×›×•×ª ××•×ª×××•×ª ×œ×¤×œ×˜×¤×•×¨××•×ª</h3>
                                        
                                        {improvedCards.whatsapp && (
                                            <div className="bg-green-50 border-2 border-green-200 p-6 rounded-xl">
                                                <div className="flex items-center gap-2 mb-3">
                                                    <span className="text-2xl">ğŸ“±</span>
                                                    <h4 className="text-lg font-semibold text-green-800">××•×ª×× ×œ-WhatsApp</h4>
                                                </div>
                                                <div className="text-gray-700 whitespace-pre-wrap font-medium hebrew-text">
                                                    {improvedCards.whatsapp}
                                                </div>
                                                <button
                                                    onClick={() => navigator.clipboard.writeText(improvedCards.whatsapp).then(() => alert('×”×‘×¨×›×” ×œ-WhatsApp ×”×•×¢×ª×§×” ×œ×œ×•×—'))}
                                                    className="mt-3 bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700 transition-colors"
                                                >
                                                    ×”×¢×ª×§ ×œ-WhatsApp
                                                </button>
                                            </div>
                                        )}
                                        
                                        {improvedCards.facebook && (
                                            <div className="bg-blue-50 border-2 border-blue-200 p-6 rounded-xl">
                                                <div className="flex items-center gap-2 mb-3">
                                                    <span className="text-2xl">ğŸ“˜</span>
                                                    <h4 className="text-lg font-semibold text-blue-800">××•×ª×× ×œ-Facebook</h4>
                                                </div>
                                                <div className="text-gray-700 whitespace-pre-wrap font-medium hebrew-text">
                                                    {improvedCards.facebook}
                                                </div>
                                                <button
                                                    onClick={() => navigator.clipboard.writeText(improvedCards.facebook).then(() => alert('×”×‘×¨×›×” ×œ-Facebook ×”×•×¢×ª×§×” ×œ×œ×•×—'))}
                                                    className="mt-3 bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700 transition-colors"
                                                >
                                                    ×”×¢×ª×§ ×œ-Facebook
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                )}

                                {/* ×›×¤×ª×•×¨×™ ×¤×¢×•×œ×” */}
                                <div className="flex justify-center gap-4 flex-wrap">
                                    <button
                                        onClick={download_card_as_image}
                                        className="bg-green-600 text-white px-6 py-3 rounded-lg font-semibold flex items-center gap-2 hover:bg-green-700 transition-colors"
                                    >
                                        <Download size={20} />
                                        ×”×•×¨×“ ×›×¨×˜×™×¡
                                    </button>
                                    
                                    <button
                                        onClick={handleShare}
                                        className="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold flex items-center gap-2 hover:bg-blue-700 transition-colors"
                                    >
                                        <Share2 size={20} />
                                        ×©×ª×£
                                    </button>
                                    
                                    <button
                                        onClick={resetForm}
                                        className="bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-700 transition-colors"
                                    >
                                        ×¦×•×¨ ×‘×¨×›×” ×—×“×©×”
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const App = () => {
            return (
                <ErrorBoundary>
                    <GreetingCardGenerator />
                </ErrorBoundary>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>